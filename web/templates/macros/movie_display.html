{# 影片展示宏 #}
{% macro render_movie_grid(movies) %}
<div class="movies-grid">
    {% for movie in movies %}
    
    <div class="{% if movie.is_exist %}exist-movie-card{% else %}movie-card{% endif %}" onclick="window.location.href='/jav-movie-detail/{{ movie.code }}'">
        <!-- 单体书签 -->
        {% if movie.is_single %}
        <div class="bookmark bookmark-single">单体</div>
        {% endif %}
        
        <!-- 字幕书签 -->
        {% if movie.is_subtitle %}
        <div class="bookmark bookmark-subtitle">字幕</div>
        {% endif %}
        
       
        <a href="#" onclick="openImageModal('{{ get_movie_cover_url(movie) }}', '{{ movie.title }}'); event.stopPropagation(); return false;">
            <div class="movie-cover-container">
                <img src="{{ get_movie_cover_url(movie) }}"
                     class="movie-cover-image" 
                     alt="{{ movie.title }}"
                     loading="lazy"
                     crossorigin="anonymous"
                     decoding="async"
                     referrerpolicy="no-referrer-when-downgrade"
                     onerror="this.src='/static/icon/default-movie.png'">
            </div>
        </a>
        <div class="movie-card-body">
            <p class="movie-title">{{ movie.title }}</p>
        </div>
    </div>
    {% endfor %}
</div>
{% endmacro %}

{# 分页导航宏 #}
{% macro render_pagination(page, total, per_page, url_for, url_params={}) %}
{% if total > per_page %}
<div class="pagination-container">
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center flex-wrap">
            {% if page > 1 %}
            <li class="page-item">
                {% if url_params.actress_movies %}
                <a class="page-link" href="{{ url_for('actress_movies', code=url_params.code, page=page-1, search=url_params.search, is_single=url_params.is_single, is_subtitle=url_params.is_subtitle) }}">上一页</a>
                {% elif url_params.series_movies_page %}
                <a class="page-link" href="{{ url_for('series_movies_page', series_name=url_params.series_name, page=page-1, search=url_params.search, is_single=url_params.is_single, is_subtitle=url_params.is_subtitle) }}">上一页</a>
                {% elif url_params.studio_movies_page %}
                <a class="page-link" href="{{ url_for('studio_movies_page', studio_name=url_params.studio_name, page=page-1, search=url_params.search, is_single=url_params.is_single, is_subtitle=url_params.is_subtitle) }}">上一页</a>
                {% elif url_params.genres_search_results %}
                <a class="page-link" href="{{ url_for('genres_search_results', page=page-1, genres=url_params.genres, search=url_params.search, is_single=url_params.is_single, is_subtitle=url_params.is_subtitle, sort_by=url_params.sort_by) }}">上一页</a>
                {% else %}
                <a class="page-link" href="{{ url_for('movies_page', page=page-1, search=url_params.search, is_single=url_params.is_single, is_subtitle=url_params.is_subtitle, sort=url_params.sort_by) }}">上一页</a>
                {% endif %}
            </li>
            {% endif %}
            
            {% set total_pages = (total // per_page) + (1 if total % per_page > 0 else 0) %}
            {% set start_page = [1, page-2]|max %}
            {% set end_page = [start_page+4, total_pages]|min %}
            {% if end_page - start_page < 4 %}
                {% set start_page = [1, end_page-4]|max %}
            {% endif %}
            
            {% for p in range(start_page, end_page+1) %}
            <li class="page-item {% if p == page %}active disabled{% endif %}">
                {% if p == page %}
                <span class="page-link">{{ p }}</span>
                {% else %}
                    {% if url_params.actress_movies %}
                    <a class="page-link" href="{{ url_for('actress_movies', code=url_params.code, page=p, search=url_params.search, is_single=url_params.is_single, is_subtitle=url_params.is_subtitle) }}">{{ p }}</a>
                    {% elif url_params.series_movies_page %}
                    <a class="page-link" href="{{ url_for('series_movies_page', series_name=url_params.series_name, page=p, search=url_params.search, is_single=url_params.is_single, is_subtitle=url_params.is_subtitle) }}">{{ p }}</a>
                    {% elif url_params.studio_movies_page %}
                    <a class="page-link" href="{{ url_for('studio_movies_page', studio_name=url_params.studio_name, page=p, search=url_params.search, is_single=url_params.is_single, is_subtitle=url_params.is_subtitle) }}">{{ p }}</a>
                    {% elif url_params.genres_search_results %}
                    <a class="page-link" href="{{ url_for('genres_search_results', page=p, genres=url_params.genres, search=url_params.search, is_single=url_params.is_single, is_subtitle=url_params.is_subtitle, sort_by=url_params.sort_by) }}">{{ p }}</a>
                    {% else %}
                    <a class="page-link" href="{{ url_for('movies_page', page=p, search=url_params.search, is_single=url_params.is_single, is_subtitle=url_params.is_subtitle, sort=url_params.sort_by) }}">{{ p }}</a>
                    {% endif %}
                {% endif %}
            </li>
            {% endfor %}
            
            {% if page < total_pages %}
            <li class="page-item">
                {% if url_params.actress_movies %}
                <a class="page-link" href="{{ url_for('actress_movies', code=url_params.code, page=page+1, search=url_params.search, is_single=url_params.is_single, is_subtitle=url_params.is_subtitle) }}">下一页</a>
                {% elif url_params.series_movies_page %}
                <a class="page-link" href="{{ url_for('series_movies_page', series_name=url_params.series_name, page=page+1, search=url_params.search, is_single=url_params.is_single, is_subtitle=url_params.is_subtitle) }}">下一页</a>
                {% elif url_params.studio_movies_page %}
                <a class="page-link" href="{{ url_for('studio_movies_page', studio_name=url_params.studio_name, page=page+1, search=url_params.search, is_single=url_params.is_single, is_subtitle=url_params.is_subtitle) }}">下一页</a>
                {% elif url_params.genres_search_results %}
                <a class="page-link" href="{{ url_for('genres_search_results', page=page+1, genres=url_params.genres, search=url_params.search, is_single=url_params.is_single, is_subtitle=url_params.is_subtitle, sort_by=url_params.sort_by) }}">下一页</a>
                {% else %}
                <a class="page-link" href="{{ url_for('movies_page', page=page+1, search=url_params.search, is_single=url_params.is_single, is_subtitle=url_params.is_subtitle, sort=url_params.sort_by) }}">下一页</a>
                {% endif %}
            </li>
            {% endif %}
        </ul>
    </nav>
    
    <!-- 页码跳转输入框 -->
    <div class="d-flex justify-content-center mt-3">
        <div class="input-group" style="max-width: 300px;">
            <input type="number" class="form-control" id="pageJumpInput" placeholder="输入页码" min="1" max="{{ total_pages }}" value="{{ page }}">
            <button class="btn btn-outline-secondary" type="button" onclick="jumpToPage()">跳转</button>
        </div>
        <small class="text-muted ms-2 align-self-center">共 {{ total_pages }} 页</small>
    </div>
</div>

<script>
function jumpToPage() {
    const input = document.getElementById('pageJumpInput');
    const targetPage = parseInt(input.value);
    const totalPages = {{ total_pages }};
    
    if (targetPage < 1 || targetPage > totalPages || isNaN(targetPage)) {
        alert('请输入有效的页码 (1-' + totalPages + ')');
        return;
    }
    
    if (targetPage === {{ page }}) {
        return; // 当前页不需要跳转
    }
    
    // 获取当前URL的查询参数
    const urlParams = new URLSearchParams(window.location.search);
    // 更新页码参数
    urlParams.set('page', targetPage);
    
    // 构建新的URL
    const newUrl = window.location.pathname + '?' + urlParams.toString();
    window.location.href = newUrl;
}

// 支持回车键跳转
document.getElementById('pageJumpInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        jumpToPage();
    }
});
</script>
{% endif %}
{% endmacro %}

{# 获取电影封面URL的辅助函数 #}
{% macro get_movie_cover_url(movie) %}
{%- if movie.cover_image_url -%}
{{ movie.cover_image_url }}
{%- else -%}
{{ url_for('static', filename='images/covers/' + movie.code + '/' + movie.code + '_cover.jpg') }}
{%- endif -%}
{% endmacro %}

{# 图片放大模态框宏 #}
{% macro render_image_modal() %}
<!-- 图片放大模态框 -->
<div id="imageModal" class="image-modal" onclick="closeImageModal()">
    <div class="image-modal-content">
        <span class="image-modal-close" onclick="closeImageModal()">&times;</span>
        <img id="modalImage" class="modal-image" src="" alt="">
        <div id="modalCaption" class="image-modal-caption"></div>
    </div>
</div>

<style>
.image-modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.9);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.image-modal.show {
    opacity: 1;
}

.image-modal-content {
    position: relative;
    margin: auto;
    padding: 20px;
    width: 90%;
    max-width: 800px;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.modal-image {
    max-width: 100%;
    max-height: 80vh;
    object-fit: contain;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    transform: scale(0.8);
    transition: transform 0.3s ease;
}

.image-modal.show .modal-image {
    transform: scale(1);
}

.image-modal-caption {
    color: white;
    text-align: center;
    margin-top: 20px;
    font-size: 1.2rem;
    opacity: 0;
    transition: opacity 0.3s ease 0.2s;
}

.image-modal.show .image-modal-caption {
    opacity: 1;
}

.image-modal-close {
    position: absolute;
    top: 20px;
    right: 30px;
    color: white;
    font-size: 40px;
    font-weight: bold;
    cursor: pointer;
    z-index: 10000;
    opacity: 0.7;
    transition: opacity 0.3s ease;
}

.image-modal-close:hover {
    opacity: 1;
    transform: scale(1.1);
}

@media (max-width: 768px) {
    .image-modal-content {
        padding: 10px;
    }
    
    .modal-image {
        max-height: 70vh;
    }
    
    .image-modal-close {
        top: 10px;
        right: 20px;
        font-size: 30px;
    }
}
</style>

<script>
function openImageModal(imageSrc, caption) {
    const modal = document.getElementById('imageModal');
    const modalImage = document.getElementById('modalImage');
    const modalCaption = document.getElementById('modalCaption');
    
    modalImage.src = imageSrc;
    modalCaption.textContent = caption;
    
    modal.style.display = 'block';
    
    // 添加动画效果
    setTimeout(() => {
        modal.classList.add('show');
    }, 10);
    
    document.body.style.overflow = 'hidden';
}

function closeImageModal() {
    const modal = document.getElementById('imageModal');
    
    // 添加淡出动画
    modal.classList.remove('show');
    
    setTimeout(() => {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }, 300);
}

// 点击模态框背景关闭
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('imageModal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeImageModal();
            }
        });
    }
});

// ESC键关闭模态框
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeImageModal();
    }
});
</script>
{% endmacro %}