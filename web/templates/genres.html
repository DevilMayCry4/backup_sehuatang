{% extends "base.html" %}
{% from 'macros/movie_display.html' import render_movie_grid, render_pagination, get_movie_cover_url %}

{% block title %}分类管理{% endblock %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/movie_display.css') }}">
{% endblock %}


{% block content %}
<style>
/* 分类选择区域样式 */
.genres-selection {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    border: 1px solid #e9ecef;
}

.category-section {
    margin-bottom: 1.5rem;
}

.category-section:last-child {
    margin-bottom: 0;
}

.category-title {
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.75rem;
    font-size: 1.1rem;
    border-bottom: 2px solid #007bff;
    padding-bottom: 0.5rem;
}

.genre-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.genre-tag {
    display: inline-block;
    padding: 0.5rem 1rem;
    background: white;
    border: 2px solid #dee2e6;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
    user-select: none;
}

.genre-tag:hover {
    border-color: #007bff;
    background: #e3f2fd;
    transform: translateY(-1px);
}

.genre-tag.selected {
    background: #007bff;
    border-color: #007bff;
    color: white;
    box-shadow: 0 2px 8px rgba(0,123,255,0.3);
}

/* 搜索和筛选区域样式 */
.search-filters {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    border: 1px solid #e9ecef;
}

.filter-group {
    margin-bottom: 1rem;
}

.filter-group:last-child {
    margin-bottom: 0;
}

.filter-label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.5rem;
    display: block;
}

/* 加载状态样式 */
.loading {
    text-align: center;
    padding: 3rem;
    color: #6c757d;
}

.spinner-border {
    width: 3rem;
    height: 3rem;
}

/* 移动端优化 */
@media (max-width: 768px) {
    .genres-selection {
        padding: 1rem;
    }
    
    .search-filters {
        padding: 1rem;
    }
    
    .genre-tag {
        padding: 0.4rem 0.8rem;
        font-size: 0.85rem;
    }
}
</style>

<div class="container mt-4">
    <h2 class="mb-4">分类管理</h2>
    
    <!-- 分类选择区域 -->
    <div class="genres-selection">
        <h5 class="mb-3">选择分类</h5>
        <div id="genresContainer">
            {% for category, genres in genres_by_category.items() %}
            <div class="category-section">
                <div class="category-title">{{ category }}</div>
                <div class="genre-tags">
                    {% for genre in genres %}
                    <span class="genre-tag" data-code="{{ genre.code }}" data-name="{{ genre.name }}">
                        {{ genre.name }}
                    </span>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="mt-3">
            <button class="btn btn-outline-secondary" id="clearGenres">
                <i class="bi bi-x-circle"></i> 清除选择
            </button>
            <span class="ms-3 text-muted" id="selectedCount">已选择 0 个分类</span>
        </div>
    </div>
    
    <!-- 搜索和筛选区域 -->
    <div class="search-filters">
        <div class="row">
            <!-- 搜索框 -->
            <div class="col-md-6 filter-group">
                <label class="filter-label">搜索电影</label>
                <input type="text" 
                       class="form-control" 
                       id="searchKeyword"
                       placeholder="搜索电影标题、番号、演员或类型..." 
                       aria-label="搜索">
            </div>
            
            <!-- 排序选择 -->
            <div class="col-md-3 filter-group">
                <label class="filter-label">排序方式</label>
                <select class="form-select" id="sortBy">
                    <option value="release_date">发布日期</option>
                    <option value="title">标题</option>
                    <option value="code">番号</option>
                </select>
            </div>
            
            <!-- 搜索按钮 -->
            <div class="col-md-3 filter-group d-flex align-items-end">
                <button class="btn btn-primary me-2" id="searchBtn">
                    <i class="bi bi-search"></i> 搜索
                </button>
                <button class="btn btn-outline-secondary" id="clearSearch">
                    <i class="bi bi-x-circle"></i> 清除
                </button>
            </div>
        </div>
        
        <div class="row mt-3">
            <!-- 单体筛选 -->
            <div class="col-md-6 filter-group">
                <label class="filter-label">单体筛选</label>
                <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="is_single" value="" id="single_all" checked>
                    <label class="btn btn-outline-secondary" for="single_all">全部</label>
                    
                    <input type="radio" class="btn-check" name="is_single" value="true" id="single_yes">
                    <label class="btn btn-outline-primary" for="single_yes">单体</label>
                    
                    <input type="radio" class="btn-check" name="is_single" value="false" id="single_no">
                    <label class="btn btn-outline-warning" for="single_no">非单体</label>
                </div>
            </div>
            
            <!-- 字幕筛选 -->
            <div class="col-md-6 filter-group">
                <label class="filter-label">字幕筛选</label>
                <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="is_subtitle" value="" id="subtitle_all" checked>
                    <label class="btn btn-outline-secondary" for="subtitle_all">全部</label>
                    
                    <input type="radio" class="btn-check" name="is_subtitle" value="true" id="subtitle_yes">
                    <label class="btn btn-outline-success" for="subtitle_yes">有字幕</label>
                    
                    <input type="radio" class="btn-check" name="is_subtitle" value="false" id="subtitle_no">
                    <label class="btn btn-outline-danger" for="subtitle_no">无字幕</label>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 搜索结果区域 -->
    <div id="searchResults">
        <!-- 初始状态提示 -->
        <div class="alert alert-info text-center" id="initialTip">
            <i class="bi bi-info-circle"></i> 
            请选择分类或输入关键词开始搜索
        </div>
    </div>
</div>

<script>
// 全局变量
let selectedGenres = [];

// 切换分类选择状态
function toggleGenreSelection(element) {
    const code = element.dataset.code;
    const name = element.dataset.name;
    
    if (element.classList.contains('selected')) {
        // 取消选择
        element.classList.remove('selected');
        selectedGenres = selectedGenres.filter(genre => genre.code !== code);
    } else {
        // 添加选择
        element.classList.add('selected');
        selectedGenres.push({ code: code, name: name });
    }
    
    updateSelectedCount();
}

// 清除分类选择
function clearGenreSelection() {
    const genreTagsElements = document.querySelectorAll('.genre-tag');
    genreTagsElements.forEach(tag => {
        tag.classList.remove('selected');
    });
    selectedGenres = [];
    updateSelectedCount();
    
    // 清除搜索关键词
    document.getElementById('searchKeyword').value = '';
    
    // 显示初始提示
    showInitialTip();
}

// 更新选择计数
function updateSelectedCount() {
    const selectedCountElement = document.getElementById('selectedCount');
    selectedCountElement.textContent = `已选择 ${selectedGenres.length} 个分类`;
}

// 执行搜索 - 跳转到全新页面
function performSearch(page = 1) {
    const searchKeyword = document.getElementById('searchKeyword').value.trim();
    const genreNames = selectedGenres.map(genre => genre.name);
    
    // 如果没有选择分类且没有搜索关键词，显示提示
    if (genreNames.length === 0 && !searchKeyword) {
        showInitialTip();
        return;
    }
    
    // 获取筛选条件
    const isSingle = document.querySelector('input[name="is_single"]:checked').value;
    const isSubtitle = document.querySelector('input[name="is_subtitle"]:checked').value;
    const sortBy = document.getElementById('sortBy').value;
    
    // 构建URL参数
    const params = new URLSearchParams();
    
    // 添加分类参数
    genreNames.forEach(name => {
        params.append('genres', name);
    });
    
    // 添加其他参数
    if (searchKeyword) {
        params.append('search', searchKeyword);
    }
    if (isSingle) {
        params.append('is_single', isSingle);
    }
    if (isSubtitle) {
        params.append('is_subtitle', isSubtitle);
    }
    if (sortBy !== 'release_date') {
        params.append('sort_by', sortBy);
    }
    if (page > 1) {
        params.append('page', page);
    }
    
    // 跳转到搜索结果页面（全新页面）
    const searchUrl = '/genres/search?' + params.toString();
    window.location.href = searchUrl;
}

// 显示初始提示
function showInitialTip() {
    const searchResultsContainer = document.getElementById('searchResults');
    searchResultsContainer.innerHTML = `
        <div class="alert alert-info text-center" id="initialTip">
            <i class="bi bi-info-circle"></i> 
            请选择分类或输入关键词开始搜索
        </div>
    `;
}

// 清除搜索
function clearSearch() {
    // 重置搜索关键词
    document.getElementById('searchKeyword').value = '';
    
    // 重置筛选条件
    document.getElementById('single_all').checked = true;
    document.getElementById('subtitle_all').checked = true;
    document.getElementById('sortBy').value = 'release_date';
    
    // 清除分类选择
    clearGenreSelection();
    
    // 显示初始提示
    showInitialTip();
}

// 页面加载完成后绑定事件
document.addEventListener('DOMContentLoaded', function() {
    // 使用事件委托绑定分类标签点击事件
    document.getElementById('genresContainer').addEventListener('click', function(e) {
        if (e.target.classList.contains('genre-tag')) {
            toggleGenreSelection(e.target);
        }
    });
    
    // 绑定清除分类按钮事件
    document.getElementById('clearGenres').addEventListener('click', clearGenreSelection);
    
    // 绑定搜索按钮事件
    document.getElementById('searchBtn').addEventListener('click', function() {
        performSearch(1);
    });
    
    // 绑定清除搜索按钮事件
    document.getElementById('clearSearch').addEventListener('click', clearSearch);
    
    // 绑定回车键搜索
    document.getElementById('searchKeyword').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            performSearch(1);
        }
    });
});
</script>
{% endblock %}