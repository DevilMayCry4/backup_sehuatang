{% extends "base.html" %}
{% from 'macros/movie_display.html' import render_movie_grid, render_pagination, get_movie_cover_url %}

{% block title %}分类管理{% endblock %}

{% block head %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/movie_display.css') }}">
{% endblock %}


{% block content %}
<style>
/* 分类选择区域样式 */
.genres-selection {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    border: 1px solid #e9ecef;
}

.category-section {
    margin-bottom: 1.5rem;
}

.category-section:last-child {
    margin-bottom: 0;
}

.category-title {
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.75rem;
    font-size: 1.1rem;
    border-bottom: 2px solid #007bff;
    padding-bottom: 0.5rem;
}

.genre-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.genre-tag {
    display: inline-block;
    padding: 0.5rem 1rem;
    background: white;
    border: 2px solid #dee2e6;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
    user-select: none;
}

.genre-tag:hover {
    border-color: #007bff;
    background: #e3f2fd;
    transform: translateY(-1px);
}

.genre-tag.selected {
    background: #007bff;
    border-color: #007bff;
    color: white;
    box-shadow: 0 2px 8px rgba(0,123,255,0.3);
}

/* 搜索和筛选区域样式 */
.search-filters {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    border: 1px solid #e9ecef;
}

.filter-group {
    margin-bottom: 1rem;
}

.filter-group:last-child {
    margin-bottom: 0;
}

.filter-label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.5rem;
    display: block;
}

/* 加载状态样式 */
.loading {
    text-align: center;
    padding: 3rem;
    color: #6c757d;
}

.spinner-border {
    width: 3rem;
    height: 3rem;
}

/* 移动端优化 */
@media (max-width: 768px) {
    .genres-selection {
        padding: 1rem;
    }
    
    .search-filters {
        padding: 1rem;
    }
    
    .genre-tag {
        padding: 0.4rem 0.8rem;
        font-size: 0.85rem;
    }
}
</style>

<div class="container mt-4">
    <h2 class="mb-4">分类管理</h2>
    
    <!-- 分类选择区域 -->
    <div class="genres-selection">
        <h5 class="mb-3">选择分类</h5>
        <div id="genresContainer">
            {% for category, genres in genres_by_category.items() %}
            <div class="category-section">
                <div class="category-title">{{ category }}</div>
                <div class="genre-tags">
                    {% for genre in genres %}
                    <span class="genre-tag" data-code="{{ genre.code }}" data-name="{{ genre.name }}">
                        {{ genre.name }}
                    </span>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="mt-3">
            <button class="btn btn-outline-secondary" id="clearGenres">
                <i class="bi bi-x-circle"></i> 清除选择
            </button>
            <span class="ms-3 text-muted" id="selectedCount">已选择 0 个分类</span>
        </div>
    </div>
    
    <!-- 搜索和筛选区域 -->
    <div class="search-filters">
        <div class="row">
            <!-- 搜索框 -->
            <div class="col-md-6 filter-group">
                <label class="filter-label">搜索电影</label>
                <input type="text" 
                       class="form-control" 
                       id="searchKeyword"
                       placeholder="搜索电影标题、番号、演员或类型..." 
                       aria-label="搜索">
            </div>
            
            <!-- 排序选择 -->
            <div class="col-md-3 filter-group">
                <label class="filter-label">排序方式</label>
                <select class="form-select" id="sortBy">
                    <option value="release_date">发布日期</option>
                    <option value="title">标题</option>
                    <option value="code">番号</option>
                </select>
            </div>
            
            <!-- 搜索按钮 -->
            <div class="col-md-3 filter-group d-flex align-items-end">
                <button class="btn btn-primary me-2" id="searchBtn">
                    <i class="bi bi-search"></i> 搜索
                </button>
                <button class="btn btn-outline-secondary" id="clearSearch">
                    <i class="bi bi-x-circle"></i> 清除
                </button>
            </div>
        </div>
        
        <div class="row mt-3">
            <!-- 单体筛选 -->
            <div class="col-md-6 filter-group">
                <label class="filter-label">单体筛选</label>
                <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="is_single" value="" id="single_all" checked>
                    <label class="btn btn-outline-secondary" for="single_all">全部</label>
                    
                    <input type="radio" class="btn-check" name="is_single" value="true" id="single_yes">
                    <label class="btn btn-outline-primary" for="single_yes">单体</label>
                    
                    <input type="radio" class="btn-check" name="is_single" value="false" id="single_no">
                    <label class="btn btn-outline-warning" for="single_no">非单体</label>
                </div>
            </div>
            
            <!-- 字幕筛选 -->
            <div class="col-md-6 filter-group">
                <label class="filter-label">字幕筛选</label>
                <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="is_subtitle" value="" id="subtitle_all" checked>
                    <label class="btn btn-outline-secondary" for="subtitle_all">全部</label>
                    
                    <input type="radio" class="btn-check" name="is_subtitle" value="true" id="subtitle_yes">
                    <label class="btn btn-outline-success" for="subtitle_yes">有字幕</label>
                    
                    <input type="radio" class="btn-check" name="is_subtitle" value="false" id="subtitle_no">
                    <label class="btn btn-outline-danger" for="subtitle_no">无字幕</label>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 搜索结果区域 -->
    <div id="searchResults">
        <!-- 初始状态提示 -->
        <div class="alert alert-info text-center" id="initialTip">
            <i class="bi bi-info-circle"></i> 
            请选择分类或输入关键词开始搜索
        </div>
    </div>
</div>

<script>
// 全局变量
let selectedGenres = [];
let currentPage = 1;
let isLoading = false;
let currentMovies = [];
let currentPagination = {};

// DOM 元素
const genreTagsElements = document.querySelectorAll('.genre-tag');
const selectedCountElement = document.getElementById('selectedCount');
const clearGenresBtn = document.getElementById('clearGenres');
const searchKeywordInput = document.getElementById('searchKeyword');
const sortBySelect = document.getElementById('sortBy');
const searchBtn = document.getElementById('searchBtn');
const clearSearchBtn = document.getElementById('clearSearch');
const searchResultsContainer = document.getElementById('searchResults');
const initialTip = document.getElementById('initialTip');

// 初始化事件监听器
document.addEventListener('DOMContentLoaded', function() {
    // 分类标签点击事件
    genreTagsElements.forEach(tag => {
        tag.addEventListener('click', function() {
            toggleGenreSelection(this);
        });
    });
    
    // 清除分类选择
    clearGenresBtn.addEventListener('click', function() {
        clearGenreSelection();
    });
    
    // 搜索按钮点击事件
    searchBtn.addEventListener('click', function() {
        performSearch();
    });
    
    // 清除搜索
    clearSearchBtn.addEventListener('click', function() {
        clearSearch();
    });
    
    // 搜索框回车事件
    searchKeywordInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            performSearch();
        }
    });
    
    // 筛选条件变化事件
    document.querySelectorAll('input[name="is_single"], input[name="is_subtitle"]').forEach(input => {
        input.addEventListener('change', function() {
            if (selectedGenres.length > 0 || searchKeywordInput.value.trim()) {
                performSearch();
            }
        });
    });
    
    // 排序变化事件
    sortBySelect.addEventListener('change', function() {
        if (selectedGenres.length > 0 || searchKeywordInput.value.trim()) {
            performSearch();
        }
    });
});

// 切换分类选择状态
function toggleGenreSelection(element) {
    const code = element.dataset.code;
    const name = element.dataset.name;
    
    if (element.classList.contains('selected')) {
        // 取消选择
        element.classList.remove('selected');
        selectedGenres = selectedGenres.filter(genre => genre.code !== code);
    } else {
        // 添加选择
        element.classList.add('selected');
        selectedGenres.push({ code: code, name: name });
    }
    
    updateSelectedCount();
    
    // 如果有选择的分类，自动搜索
    if (selectedGenres.length > 0) {
        performSearch();
    } else if (searchKeywordInput.value.trim() === '') {
        // 如果没有选择分类且没有搜索关键词，显示初始提示
        showInitialTip();
    }
}

// 清除分类选择
function clearGenreSelection() {
    genreTagsElements.forEach(tag => {
        tag.classList.remove('selected');
    });
    selectedGenres = [];
    updateSelectedCount();
    
    if (searchKeywordInput.value.trim() === '') {
        showInitialTip();
    } else {
        performSearch();
    }
}

// 更新选择计数
function updateSelectedCount() {
    selectedCountElement.textContent = `已选择 ${selectedGenres.length} 个分类`;
}

// 执行搜索
function performSearch(page = 1) {
    const searchKeyword = searchKeywordInput.value.trim();
    const genreNames = selectedGenres.map(genre => genre.name);
    // 如果没有分类选择且没有搜索关键词，显示提示
    if (genreNames.length === 0 && !searchKeyword) {
        showInitialTip();
        return;
    }
    
    // 获取筛选条件
    const isSingle = document.querySelector('input[name="is_single"]:checked').value;
    const isSubtitle = document.querySelector('input[name="is_subtitle"]:checked').value;
    const sortBy = sortBySelect.value;
    
    // 构建URL参数
    const params = new URLSearchParams();
    
    // 添加分类参数
    genreNames.forEach(name => {
        params.append('genres', name);
    });
    
    // 添加其他参数
    if (searchKeyword) {
        params.append('search', searchKeyword);
    }
    if (isSingle) {
        params.append('is_single', isSingle);
    }
    if (isSubtitle) {
        params.append('is_subtitle', isSubtitle);
    }
    if (sortBy !== 'release_date') {
        params.append('sort_by', sortBy);
    }
    if (page > 1) {
        params.append('page', page);
    }
    
    // 跳转到搜索结果页面
    const searchUrl = '/genres/search?' + params.toString();
    window.location.href = searchUrl;
}

isLoading = true;
currentPage = page;

// 如果不是第一页，滚动到搜索结果区域
if (page > 1) {
    scrollToResults();
}

// 显示加载状态
showLoading();

// 获取筛选条件
const isSingle = document.querySelector('input[name="is_single"]:checked').value;
const isSubtitle = document.querySelector('input[name="is_subtitle"]:checked').value;
const sortBy = sortBySelect.value;

// 构建请求数据
const requestData = {
    names: genreNames,  // 修改参数名以匹配后端
    search_keyword: searchKeyword,
    is_single: isSingle,
    is_subtitle: isSubtitle,
    sort_by: sortBy,
    page: page,
    per_page: 20
};

// 发送搜索请求
fetch('/api/genres/search', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
    },
    body: JSON.stringify(requestData)
})
.then(response => response.json())
.then(data => {
    isLoading = false;
    
    if (data.success) {
        currentMovies = data.movies;
        currentPagination = data.pagination;
        displaySearchResults(data.movies, data.pagination);
        
        // 如果是分页跳转，滚动到搜索结果区域
        if (page > 1) {
            setTimeout(() => scrollToResults(), 100);
        }
    } else {
        showError(data.error || '搜索失败，请稍后重试');
    }
})
.catch(error => {
    isLoading = false;
    console.error('搜索错误:', error);
    showError('网络错误，请检查连接后重试');
});
}

// 页码跳转
function jumpToPage() {
    const input = document.getElementById('pageJumpInput');
    const targetPage = parseInt(input.value);
    const totalPages = currentPagination.pages;
    
    if (targetPage < 1 || targetPage > totalPages || isNaN(targetPage)) {
        alert('请输入有效的页码 (1-' + totalPages + ')');
        return;
    }
    
    if (targetPage === currentPagination.page) {
        return; // 当前页不需要跳转
    }
    
    performSearch(targetPage);
}

// 滚动到搜索结果区域
function scrollToResults() {
    const searchResultsElement = document.getElementById('searchResults');
    if (searchResultsElement) {
        searchResultsElement.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
        });
    }
}

// 显示搜索结果
function displaySearchResults(movies, pagination) {
    let html = '';
    
    // 搜索结果提示
    const selectedGenreNames = selectedGenres.map(genre => genre.name).join('、');
    const searchKeyword = searchKeywordInput.value.trim();
    
    if (selectedGenreNames || searchKeyword) {
        html += '<div class="alert alert-info mb-3">';
        html += '<i class="bi bi-info-circle"></i> 筛选条件：';
        
        if (selectedGenreNames) {
            html += `分类：${selectedGenreNames}`;
        }
        
        if (searchKeyword) {
            if (selectedGenreNames) html += '，';
            html += `关键词：${searchKeyword}`;
        }
        
        const isSingle = document.querySelector('input[name="is_single"]:checked').value;
        const isSubtitle = document.querySelector('input[name="is_subtitle"]:checked').value;
        
        if (isSingle === 'true') {
            html += '，单体：是';
        } else if (isSingle === 'false') {
            html += '，单体：否';
        }
        
        if (isSubtitle === 'true') {
            html += '，字幕：有';
        } else if (isSubtitle === 'false') {
            html += '，字幕：无';
        }
        
        html += `，共找到 ${pagination.total} 部影片`;
        html += '</div>';
    }
    
    // 使用宏渲染电影网格
    if (movies.length > 0) {
        // 创建临时容器来渲染宏
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = `{{ render_movie_grid(currentMovies) }}`;
        
        // 手动构建电影网格（因为无法在客户端直接使用Jinja2宏）
        html += '<div class="movies-grid">';
        
        movies.forEach(movie => {
            html += '<div class="movie-card" onclick="window.location.href=\'/jav-movie-detail/' + movie.code + '\'">';
            
            // 单体书签
            if (movie.is_single) {
                html += '<div class="bookmark bookmark-single">单体</div>';
            }
            
            // 字幕书签
            if (movie.is_subtitle) {
                html += '<div class="bookmark bookmark-subtitle">字幕</div>';
            }
            
            // 电影封面
            html += '<a href="#" onclick="openImageModal(\'' + getMovieCoverUrl(movie) + '\', \'' + movie.title + '\'); event.stopPropagation(); return false;">';
            html += '<div class="movie-cover-container">';
            html += '<img src="' + getMovieCoverUrl(movie) + '" class="movie-cover-image" alt="' + movie.title + '" loading="lazy" onerror="this.src=\'/static/images/no-image.jpg\'">';
            html += '</div>';
            html += '</a>';
            
            // 电影信息
            html += '<div class="movie-card-body">';
            html += '<p class="movie-title">' + (movie.title || '') + '</p>';
            html += '</div>';
            
            html += '</div>';
        });
        
        html += '</div>';
        
        // 分页
        if (pagination.pages > 1) {
            html += generatePagination(pagination);
        }
    } else {
        html += '<div class="alert alert-warning text-center">';
        html += '<i class="bi bi-exclamation-triangle"></i> 没有找到符合条件的影片';
        html += '</div>';
    }
    
    searchResultsContainer.innerHTML = html;
}

// 获取电影封面URL（客户端版本）
function getMovieCoverUrl(movie) {
    if (movie.cover_image_url) {
        return movie.cover_image_url;
    } else {
        return '/static/images/covers/' + movie.code + '/' + movie.code + '_cover.jpg';
    }
}

// 生成分页HTML
function generatePagination(pagination) {
    let html = '<div class="pagination-container">';
    html += '<nav aria-label="搜索结果分页">';
    html += '<ul class="pagination justify-content-center">';
    
    // 上一页
    if (pagination.has_prev) {
        html += '<li class="page-item">';
        html += '<a class="page-link" href="#" onclick="performSearch(' + pagination.prev_num + ')" aria-label="上一页">';
        html += '<span aria-hidden="true">&laquo;</span>';
        html += '</a>';
        html += '</li>';
    } else {
        html += '<li class="page-item disabled">';
        html += '<span class="page-link" aria-label="上一页">';
        html += '<span aria-hidden="true">&laquo;</span>';
        html += '</span>';
        html += '</li>';
    }
    
    // 页码
    const startPage = Math.max(1, pagination.page - 2);
    const endPage = Math.min(pagination.pages, pagination.page + 2);
    
    if (startPage > 1) {
        html += '<li class="page-item">';
        html += '<a class="page-link" href="#" onclick="performSearch(1)">1</a>';
        html += '</li>';
        if (startPage > 2) {
            html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        if (i === pagination.page) {
            html += '<li class="page-item active">';
            html += '<span class="page-link">' + i + '</span>';
            html += '</li>';
        } else {
            html += '<li class="page-item">';
            html += '<a class="page-link" href="#" onclick="performSearch(' + i + ')">' + i + '</a>';
            html += '</li>';
        }
    }
    
    if (endPage < pagination.pages) {
        if (endPage < pagination.pages - 1) {
            html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
        html += '<li class="page-item">';
        html += '<a class="page-link" href="#" onclick="performSearch(' + pagination.pages + ')">' + pagination.pages + '</a>';
        html += '</li>';
    }
    
    // 下一页
    if (pagination.has_next) {
        html += '<li class="page-item">';
        html += '<a class="page-link" href="#" onclick="performSearch(' + pagination.next_num + ')" aria-label="下一页">';
        html += '<span aria-hidden="true">&raquo;</span>';
        html += '</a>';
        html += '</li>';
    } else {
        html += '<li class="page-item disabled">';
        html += '<span class="page-link" aria-label="下一页">';
        html += '<span aria-hidden="true">&raquo;</span>';
        html += '</span>';
        html += '</li>';
    }
    
    html += '</ul>';
    html += '</nav>';
    
    // 页码跳转输入框
    html += '<div class="d-flex justify-content-center mt-3">';
    html += '<div class="input-group" style="max-width: 300px;">';
    html += '<input type="number" class="form-control" id="pageJumpInput" placeholder="输入页码" min="1" max="' + pagination.pages + '" value="' + pagination.page + '">';
    html += '<button class="btn btn-outline-secondary" type="button" onclick="jumpToPage()">跳转</button>';
    html += '</div>';
    html += '<small class="text-muted ms-2 align-self-center">共 ' + pagination.pages + ' 页</small>';
    html += '</div>';
    
    html += '</div>';
    
    return html;
}

// 页码跳转
function jumpToPage() {
    const input = document.getElementById('pageJumpInput');
    const targetPage = parseInt(input.value);
    const totalPages = currentPagination.pages;
    
    if (targetPage < 1 || targetPage > totalPages || isNaN(targetPage)) {
        alert('请输入有效的页码 (1-' + totalPages + ')');
        return;
    }
    
    if (targetPage === currentPagination.page) {
        return; // 当前页不需要跳转
    }
    
    performSearch(targetPage);
}

// 显示加载状态
function showLoading() {
    searchResultsContainer.innerHTML = `
        <div class="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
            <div class="mt-3">正在搜索影片...</div>
        </div>
    `;
}

// 显示错误信息
function showError(message) {
    searchResultsContainer.innerHTML = `
        <div class="alert alert-danger text-center">
            <i class="bi bi-exclamation-triangle"></i> ${message}
        </div>
    `;
}

// 显示初始提示
function showInitialTip() {
    searchResultsContainer.innerHTML = `
        <div class="alert alert-info text-center" id="initialTip">
            <i class="bi bi-info-circle"></i> 
            请选择分类或输入关键词开始搜索
        </div>
    `;
}

// 清除搜索
function clearSearch() {
    searchKeywordInput.value = '';
    document.getElementById('single_all').checked = true;
    document.getElementById('subtitle_all').checked = true;
    sortBySelect.value = 'release_date';
    if (selectedGenres.length === 0) {
        showInitialTip();
    } else {
        performSearch();
    }
}
</script>
{% endblock %}