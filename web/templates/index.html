{% extends "base.html" %}

{% block content %}
<style>
/* 图片样式优化 */
.movie-image {
    border-radius: 8px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.movie-image:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 16px rgba(0,0,0,0.2);
}

/* 电影卡片样式 */
.movie-item {
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    background: #fff;
    transition: box-shadow 0.3s ease;
}

.movie-item:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

/* 电影信息布局优化 */
.movie-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;
}

.movie-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 12px;
}

.movie-meta .badge {
    font-size: 0.75rem;
}

/* 磁力链接容器样式 */
.magnet-link-container {
    background: #f8f9fa;
    border-radius: 6px;
    padding: 10px;
    margin-bottom: 10px;
}

/* 响应式调整 */
@media (max-width: 768px) {
    .movie-header {
        flex-direction: column;
        gap: 8px;
    }
    
    .movie-meta {
        justify-content: flex-start;
    }
}
</style>

<div class="search-container">
    <div class="card">
        <div class="card-header">
            <h4 class="mb-0"><i class="bi bi-search"></i> 电影搜索</h4>
        </div>
        <div class="card-body">
            <form id="searchForm">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="movieName" placeholder="请输入电影名称或系列URL..." required>
                    <button class="btn btn-primary" type="submit" id="searchBtn">
                        <i class="bi bi-search"></i> 搜索
                    </button>
                </div>
            </form>
            
            <!-- 加载状态 -->
            <div id="loading" class="text-center d-none">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">搜索中...</span>
                </div>
                <p class="mt-2">正在搜索电影并检查Jellyfin状态...</p>
            </div>
        </div>
    </div>

    <!-- 搜索结果 -->
    <div id="results" class="result-container d-none">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <h5 class="mb-0 me-3"><i class="bi bi-list-ul"></i> 搜索结果</h5>
                    <div class="form-check me-3">
                        <input class="form-check-input" type="checkbox" id="selectAll">
                        <label class="form-check-label" for="selectAll">
                            全选
                        </label>
                    </div>
                </div>
                <div class="d-flex align-items-center">
                    <div id="resultStats" class="text-muted me-3"></div>
                    <button id="subscribeBtn" class="btn btn-success btn-sm" onclick="subscribeSelected()" disabled>
                        <i class="bi bi-download"></i> 订阅选中 (<span id="selectedCount">0</span>)
                    </button>
                </div>
            </div>
            <div class="card-body" id="resultsContent">
                <!-- 结果将通过JavaScript动态插入 -->
            </div>
        </div>
    </div>

    <!-- 错误提示 -->
    <div id="error" class="alert alert-danger d-none" role="alert">
        <i class="bi bi-exclamation-triangle"></i>
        <span id="errorMessage"></span>
    </div>
</div>

<!-- 成功提示模态框 -->
<div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-body text-center">
                <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                <h5 class="mt-3">复制成功！</h5>
                <p class="text-muted">已复制 <span id="copiedCount"></span> 个磁力链接到剪贴板</p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">确定</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchForm = document.getElementById('searchForm');
    const movieNameInput = document.getElementById('movieName');
    const searchBtn = document.getElementById('searchBtn');
    const loading = document.getElementById('loading');
    const results = document.getElementById('results');
    const resultsContent = document.getElementById('resultsContent');
    const error = document.getElementById('error');
    const errorMessage = document.getElementById('errorMessage');
    const resultStats = document.getElementById('resultStats');
    const selectAllCheckbox = document.getElementById('selectAll');
    const subscribeBtn = document.getElementById('subscribeBtn');
    const selectedCountSpan = document.getElementById('selectedCount');
    
    let currentMovies = []; // 存储当前搜索结果
    
    // 搜索表单提交
    searchForm.addEventListener('submit', function(e) {
        e.preventDefault();
        searchMovies();
    });
    
    // 全选/取消全选 - 修复：只选择未禁用的复选框
    selectAllCheckbox.addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.movie-checkbox:not(:disabled)');
        checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateSelectedCount();
    });
    
    // 更新选中数量
    function updateSelectedCount() {
        const selectedCheckboxes = document.querySelectorAll('.movie-checkbox:checked');
        const count = selectedCheckboxes.length;
        selectedCountSpan.textContent = count;
        subscribeBtn.disabled = count === 0;
        
        // 更新全选状态 - 修复：只考虑未禁用的复选框
        const enabledCheckboxes = document.querySelectorAll('.movie-checkbox:not(:disabled)');
        const selectedEnabledCheckboxes = document.querySelectorAll('.movie-checkbox:not(:disabled):checked');
        
        if (enabledCheckboxes.length > 0) {
            selectAllCheckbox.checked = selectedEnabledCheckboxes.length === enabledCheckboxes.length;
            selectAllCheckbox.indeterminate = selectedEnabledCheckboxes.length > 0 && selectedEnabledCheckboxes.length < enabledCheckboxes.length;
        }
    }
    
    // 搜索电影
    async function searchMovies() {
        const movieName = movieNameInput.value.trim();
        if (!movieName) return;
        
        // 显示加载状态
        loading.classList.remove('d-none');
        results.classList.add('d-none');
        error.classList.add('d-none');
        searchBtn.disabled = true;
        
        try {
            const response = await fetch('/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    movie_name: movieName
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                currentMovies = data.result.movies || [];
                displayResults(data.result);
            } else {
                showError(data.error || '搜索失败');
            }
        } catch (err) {
            console.error('搜索错误:', err);
            showError('网络错误，请稍后重试');
        } finally {
            loading.classList.add('d-none');
            searchBtn.disabled = false;
        }
    }
    
    // 显示错误
    function showError(message) {
        errorMessage.textContent = message;
        error.classList.remove('d-none');
        results.classList.add('d-none');
    }
    
    // 显示搜索结果 - 优化布局
    function displayResults(result) {
        let html = '';
        
        // 显示统计信息
        if (result.total_movies > 0) {
            resultStats.innerHTML = `共找到 ${result.total_movies} 部电影`;
            
            // 显示爬虫信息
            if (result.crawler_info) {
                html += `
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-info-circle"></i>
                        <strong>爬取信息:</strong> 
                        共爬取 ${result.crawler_info.total_pages_crawled} 页，
                        找到 ${result.crawler_info.total_movies_found} 部电影
                    </div>
                `;
            }
            
            // 显示电影列表 - 优化布局
            result.movies.forEach((movie, index) => {
                const jellyfinStatus = movie.jellyfin_exists ? 
                    '<span class="badge bg-success"><i class="bi bi-check-circle"></i> 已存在</span>' :
                    '<span class="badge bg-secondary"><i class="bi bi-x-circle"></i> 未找到</span>';
                
                // 构建标签数组
                const movieTags = [];
                if (movie.has_hd) movieTags.push('<span class="badge bg-primary">高清</span>');
                if (movie.has_subtitle) movieTags.push('<span class="badge bg-warning text-dark">字幕</span>');
                
                // 添加磁力链接标识
                const magnetStatus = movie.has_magnet ? 
                    '<span class="badge bg-success"><i class="bi bi-magnet"></i> 有磁力链接</span>' :
                    '<span class="badge bg-light text-muted"><i class="bi bi-x-circle"></i> 无磁力链接</span>';
                
                html += `
                    <div class="movie-item">
                        <div class="row align-items-start">
                            <div class="col-md-1 col-sm-1 d-flex align-items-center justify-content-center">
                                <div class="form-check">
                                    <input class="form-check-input movie-checkbox" type="checkbox" 
                                           id="movie-${index}" data-index="${index}" 
                                           ${movie.has_magnet ? '' : 'disabled'}
                                           onchange="updateSelectedCount()">
                                    <label class="form-check-label" for="movie-${index}"></label>
                                </div>
                            </div>
                            <div class="col-md-2 col-sm-3 d-flex align-items-center justify-content-center mb-3" style="min-height: 160px;">
                                ${movie.image_url ? 
                                    `<img src="${movie.image_url}" alt="${movie.title}" class="movie-image img-fluid" 
                                         style="max-width: 120px; max-height: 160px; object-fit: cover;"
                                         onerror="console.log('图片加载失败 URL:', this.src); this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjE2MCIgdmlld0JveD0iMCAwIDEyMCAxNjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjAiIGhlaWdodD0iMTYwIiBmaWxsPSIjRjhGOUZBIi8+CjxwYXRoIGQ9Ik00MCA2MEw4MCA2MEw2MCA5MEw0MCA2MFoiIGZpbGw9IiNEMUQ1REIiLz4KPC9zdmc+'">` :
                                    `<div class="movie-image d-flex align-items-center justify-content-center bg-light text-muted" style="width:120px;height:160px; border-radius: 8px;">
                                        <i class="bi bi-film" style="font-size: 2rem;"></i>
                                    </div>`
                                }
                            </div>
                            <div class="col-md-9 col-sm-8">
                                <div class="movie-info">
                                    <!-- 优化的标题和状态布局 -->
                                    <div class="movie-header">
                                        <p class="movie-title mb-0" style="font-size: 0.9rem;">
                                            ${movie.title || '未知标题'}
                                        </p>
                                        ${jellyfinStatus}
                                    </div>
                                    
                                    <!-- 优化的元数据布局 -->
                                    <div class="movie-meta">
                                        <span class="badge bg-info">编号: ${movie.movie_code || 'N/A'}</span>
                                        ${movie.release_date ? 
                                            `<span class="badge bg-secondary">发布: ${movie.release_date}</span>` : ''
                                        }
                                        ${magnetStatus}
                                        ${movieTags.join('')}
                                    </div>
                                    
                                    ${movie.has_magnet && movie.magnet_link ? 
                                        `<div class="magnet-link-container">
                                            <small class="text-muted d-block mb-1"><i class="bi bi-magnet"></i> 磁力链接:</small>
                                            <div class="input-group input-group-sm">
                                                <input type="text" class="form-control" value="${movie.magnet_link}" readonly>
                                                <button class="btn btn-outline-secondary" type="button" 
                                                        onclick="copyToClipboard('${movie.magnet_link.replace(/'/g, "\\'")}')" 
                                                        title="复制磁力链接">
                                                    <i class="bi bi-copy"></i>
                                                </button>
                                            </div>
                                        </div>` : ''
                                    }
                                    
                                    <div class="movie-actions mt-2">
                                        ${movie.movie_url ? 
                                            `<a href="${movie.movie_url}" target="_blank" class="btn btn-sm btn-outline-primary me-2">
                                                <i class="bi bi-box-arrow-up-right"></i> 查看详情
                                            </a>` : ''
                                        }
                                        
                                        ${movie.jellyfin_exists && movie.jellyfin_details && movie.jellyfin_details.length > 0 ? 
                                            `<button class="btn btn-sm btn-success" onclick="showJellyfinDetails(${index})">
                                                <i class="bi bi-info-circle"></i> Jellyfin详情
                                            </button>` : ''
                                        }
                                    </div>
                                    
                                    ${movie.jellyfin_exists && movie.jellyfin_details ? 
                                        `<div id="jellyfin-details-${index}" class="jellyfin-details mt-2 d-none">
                                            <div class="alert alert-success">
                                                <strong>Jellyfin中的信息:</strong><br>
                                                ${movie.jellyfin_details.map(detail => 
                                                    `<div class="mb-1">
                                                        <strong>${detail.name}</strong> (${detail.year || 'N/A'})<br>
                                                        <small class="text-muted">库: ${detail.library} | 路径: ${detail.path || 'N/A'}</small>
                                                    </div>`
                                                ).join('')}
                                            </div>
                                        </div>` : ''
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        } else {
            html = `
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>未找到电影:</strong> "${result.search_term || movieNameInput.value}"
                </div>
                <p class="text-muted">建议:</p>
                <ul class="text-muted">
                    <li>检查搜索关键词拼写</li>
                    <li>尝试使用不同的关键词</li>
                    <li>使用完整的系列URL进行搜索</li>
                </ul>
            `;
        }
        
        resultsContent.innerHTML = html;
        results.classList.remove('d-none');
        
        // 重置选择状态
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
        updateSelectedCount();
    }
    
    // 全局函数：显示Jellyfin详情
    window.showJellyfinDetails = function(index) {
        const detailsDiv = document.getElementById(`jellyfin-details-${index}`);
        if (detailsDiv) {
            detailsDiv.classList.toggle('d-none');
        }
    };
    
    // 全局函数：复制到剪贴板
    window.copyToClipboard = function(text) {
        navigator.clipboard.writeText(text).then(function() {
            // 显示简单提示
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.innerHTML = '<i class="bi bi-check-circle"></i> 已复制到剪贴板';
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 10px 15px;
                border-radius: 5px;
                z-index: 9999;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 2000);
        }, function(err) {
            console.error('复制失败: ', err);
            alert('复制失败，请手动复制');
        });
    };
    
    // 全局函数：订阅选中的电影
    window.subscribeSelected = function() {
        const selectedCheckboxes = document.querySelectorAll('.movie-checkbox:checked');
        const magnetLinks = [];
        
        selectedCheckboxes.forEach(checkbox => {
            const index = parseInt(checkbox.dataset.index);
            const movie = currentMovies[index];
            if (movie && movie.magnet_link) {
                magnetLinks.push(movie.magnet_link);
            }
        });
        
        if (magnetLinks.length > 0) {
            const allLinks = magnetLinks.join('\n');
            navigator.clipboard.writeText(allLinks).then(function() {
                // 显示成功模态框
                document.getElementById('copiedCount').textContent = magnetLinks.length;
                const modal = new bootstrap.Modal(document.getElementById('successModal'));
                modal.show();
                
                // 清除选择
                selectedCheckboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
                selectAllCheckbox.checked = false;
                updateSelectedCount();
            }, function(err) {
                console.error('复制失败: ', err);
                alert('复制失败，请手动复制');
            });
        }
    };
    
    // 全局函数：更新选中数量（供HTML调用）
    window.updateSelectedCount = updateSelectedCount;
});
</script>
{% endblock %}