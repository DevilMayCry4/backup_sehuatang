{% extends "base.html" %}

{% block content %}
<style>
/* 图片样式优化 */
.movie-image {
    border-radius: 8px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.movie-image:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 16px rgba(0,0,0,0.2);
}

/* 电影卡片样式 */
.movie-item {
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    background: #fff;
    transition: box-shadow 0.3s ease;
}

.movie-item:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

/* 电影信息布局优化 */
.movie-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;
}

.movie-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 12px;
}

.movie-meta .badge {
    font-size: 0.75rem;
}

/* 磁力链接容器样式 */
.magnet-link-container {
    background: #f8f9fa;
    border-radius: 6px;
    padding: 10px;
    margin-bottom: 10px;
}

/* 定时推送卡片样式 */
.subscription-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
}

.subscription-card .card-header {
    background: rgba(255,255,255,0.1);
    border-bottom: 1px solid rgba(255,255,255,0.2);
}

/* 响应式调整 */
@media (max-width: 768px) {
    .movie-header {
        flex-direction: column;
        gap: 8px;
    }
    
    .movie-meta {
        justify-content: flex-start;
    }
}
</style>

<div class="search-container">
    <!-- 定时推送功能卡片 -->
    <div class="card subscription-card mb-4">
        <div class="card-header">
            <h4 class="mb-0"><i class="bi bi-bell"></i> 定时推送订阅</h4>
        </div>
        <div class="card-body">
            <p class="mb-3">订阅电影系列，系统将每天晚上自动检查新电影并推送磁力链接</p>
            <form id="subscriptionForm">
                <div class="row">
                    <div class="col-md-8">
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="seriesName" 
                                   placeholder="请输入电影系列名称（如：SSIS）" required>
                            <button class="btn btn-warning" type="submit" id="subscribeSeriesBtn">
                                <i class="bi bi-plus-circle"></i> 订阅系列
                            </button>
                        </div>
                    </div>
                    <!-- 在订阅卡片的card-body中，查看订阅列表按钮后添加 -->
                    <div class="col-md-4">
                        <button type="button" class="btn btn-outline-light" id="viewSubscriptionsBtn">
                            <i class="bi bi-list"></i> 查看订阅列表
                        </button>
                        <button type="button" class="btn btn-warning d-none d-md-inline-block" id="triggerCheckBtn" style="margin-left: 8px;">
                            <i class="bi bi-play-circle"></i> 手动检查
                        </button>
                    </div>
                </div>
                
                <!-- 移动端按钮区域 -->
                <div class="d-md-none mt-3">
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-warning" id="triggerCheckBtnMobile">
                            <i class="bi bi-play-circle"></i> 手动检查
                        </button>
                        <button type="button" class="btn btn-info" id="crawlAllStarBtnMobile">
                            <i class="bi bi-people"></i> 更新全部演员电影
                        </button>
                        <button type="button" class="btn btn-success" id="crawlTopStarBtnMobile">
                            <i class="bi bi-star"></i> 更新热门演员
                        </button>
                        <button type="button" class="btn btn-danger" id="updateSehuatangBtnMobile">
                            <i class="bi bi-arrow-clockwise"></i> 更新论坛电影
                        </button>
                        <button type="button" class="btn btn-warning" id="retryFailedMoviesBtnMobile">
                            <i class="bi bi-arrow-repeat"></i> 重试失败电影
                        </button>
                        <button type="button" class="btn btn-secondary" id="backupImagesBtnMobile">
                            <i class="bi bi-archive"></i> 备份图片
                        </button>
                        <button type="button" class="btn btn-warning" id="retryFailedImagesBtnMobile">
                            <i class="bi bi-arrow-repeat"></i> 重试失败图片
                        </button>
                        <button type="button" class="btn btn-primary" id="updateJavHomeBtnMobile">
                            <i class="bi bi-house"></i> 更新JAV首页
                        </button>
                        
                    </div>
                </div>
                
                <!-- 桌面端爬虫功能按钮区域 -->
                <div class="row mt-3 d-none d-md-flex">
                    <div class="col-md-3">
                        <button type="button" class="btn btn-info" id="crawlAllStarBtn">
                            <i class="bi bi-people"></i> 更新全部演员电影
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button type="button" class="btn btn-success" id="crawlTopStarBtn">
                            <i class="bi bi-star"></i> 更新热门演员
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button type="button" class="btn btn-danger" id="updateSehuatangBtn">
                            <i class="bi bi-arrow-clockwise"></i> 更新论坛电影
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button type="button" class="btn btn-warning" id="retryFailedMoviesBtn">
                            <i class="bi bi-arrow-repeat"></i> 重试失败电影
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button type="button" class="btn btn-secondary" id="backupImagesBtn">
                            <i class="bi bi-archive"></i> 备份图片
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button type="button" class="btn btn-warning" id="retryFailedImagesBtn">
                            <i class="bi bi-arrow-repeat"></i> 重试失败图片
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button type="button" class="btn btn-primary" id="updateJavHomeBtn">
                            <i class="bi bi-house"></i> 更新JAV首页
                        </button>
                    </div>
                </div>
                
                <!-- 爬虫状态提示 -->
                <div id="crawlerStatus" class="d-none mt-3">
                    <div class="spinner-border spinner-border-sm text-light me-2" role="status">
                        <span class="visually-hidden">处理中...</span>
                    </div>
                    <span id="crawlerStatusText">正在执行爬虫任务...</span>
                </div>
            </form>
            
            <!-- 订阅状态提示 -->
            <div id="subscriptionStatus" class="d-none">
                <div class="spinner-border spinner-border-sm text-light me-2" role="status">
                    <span class="visually-hidden">处理中...</span>
                </div>
                <span>正在添加订阅...</span>
            </div>
        </div>
    </div>

    <!-- 原有的搜索功能 -->
    <div class="card">
        <div class="card-header">
            <h4 class="mb-0"><i class="bi bi-search"></i> 电影搜索</h4>
        </div>
        <div class="card-body">
            <form id="searchForm">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="movieName" placeholder="请输入电影名称或系列URL..." required>
                    <button class="btn btn-primary" type="submit" id="searchBtn">
                        <i class="bi bi-search"></i> 搜索
                    </button>
                </div>
            </form>
            
            <!-- 加载状态 -->
            <div id="loading" class="text-center d-none">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">搜索中...</span>
                </div>
                <p class="mt-2">正在搜索电影并检查Jellyfin状态...</p>
            </div>
        </div>
    </div>

    <!-- 搜索结果 -->
    <div id="results" class="result-container d-none">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <h5 class="mb-0 me-3"><i class="bi bi-list-ul"></i> 搜索结果</h5>
                    <div class="form-check me-3">
                        <input class="form-check-input" type="checkbox" id="selectAll">
                        <label class="form-check-label" for="selectAll">
                            全选
                        </label>
                    </div>
                </div>
                <div class="d-flex align-items-center">
                    <div id="resultStats" class="text-muted me-3"></div>
                    <button id="subscribeBtn" class="btn btn-success btn-sm" onclick="subscribeSelected()" disabled>
                        <i class="bi bi-download"></i> 订阅选中 (<span id="selectedCount">0</span>)
                    </button>
                </div>
            </div>
            <div class="card-body" id="resultsContent">
                <!-- 结果将通过JavaScript动态插入 -->
            </div>
        </div>
    </div>

    <!-- 错误提示 -->
    <div id="error" class="alert alert-danger d-none" role="alert">
        <i class="bi bi-exclamation-triangle"></i>
        <span id="errorMessage"></span>
    </div>
</div>

<!-- 订阅列表模态框 -->
<div class="modal fade" id="subscriptionsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-list"></i> 我的订阅列表</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="subscriptionsContent">
                <!-- 订阅列表将通过JavaScript动态加载 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- 成功提示模态框 -->
<div class="modal fade" id="successModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-body text-center">
                <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                <h5 class="mt-3">操作成功！</h5>
                <p class="text-muted" id="successMessage">操作已完成</p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">确定</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 在现有JavaScript代码中添加手动触发功能
document.addEventListener('DOMContentLoaded', function() {
    const searchForm = document.getElementById('searchForm');
    const movieNameInput = document.getElementById('movieName');
    const searchBtn = document.getElementById('searchBtn');
    const loading = document.getElementById('loading');
    const results = document.getElementById('results');
    const resultsContent = document.getElementById('resultsContent');
    const error = document.getElementById('error');
    const errorMessage = document.getElementById('errorMessage');
    const resultStats = document.getElementById('resultStats');
    const selectAllCheckbox = document.getElementById('selectAll');
    const subscribeBtn = document.getElementById('subscribeBtn');
    const selectedCountSpan = document.getElementById('selectedCount');
    
    // 定时推送相关元素
    const subscriptionForm = document.getElementById('subscriptionForm');
    const seriesNameInput = document.getElementById('seriesName');
    const subscribeSeriesBtn = document.getElementById('subscribeSeriesBtn');
    const subscriptionStatus = document.getElementById('subscriptionStatus');
    const viewSubscriptionsBtn = document.getElementById('viewSubscriptionsBtn');
    const subscriptionsModal = document.getElementById('subscriptionsModal');
    const subscriptionsContent = document.getElementById('subscriptionsContent');
    const triggerCheckBtn = document.getElementById('triggerCheckBtn'); // 添加手动触发按钮元素
    
    // 爬虫功能相关元素
    const crawlAllStarBtn = document.getElementById('crawlAllStarBtn');
    const crawlTopStarBtn = document.getElementById('crawlTopStarBtn');
    const crawlAllStarBtnMobile = document.getElementById('crawlAllStarBtnMobile');
    const crawlTopStarBtnMobile = document.getElementById('crawlTopStarBtnMobile');
    const triggerCheckBtnMobile = document.getElementById('triggerCheckBtnMobile');
    const updateSehuatangBtn = document.getElementById('updateSehuatangBtn');
    const updateSehuatangBtnMobile = document.getElementById('updateSehuatangBtnMobile');
    const backupImagesBtn = document.getElementById('backupImagesBtn');
    const backupImagesBtnMobile = document.getElementById('backupImagesBtnMobile');
    const retryFailedMoviesBtn = document.getElementById('retryFailedMoviesBtn');
    const retryFailedMoviesBtnMobile = document.getElementById('retryFailedMoviesBtnMobile');
    const retryFailedImagesBtn = document.getElementById('retryFailedImagesBtn');
    const retryFailedImagesBtnMobile = document.getElementById('retryFailedImagesBtnMobile');
    const updateJavHomeBtn = document.getElementById('updateJavHomeBtn');
    const updateJavHomeBtnMobile = document.getElementById('updateJavHomeBtnMobile');
    const crawlerStatus = document.getElementById('crawlerStatus');
    const crawlerStatusText = document.getElementById('crawlerStatusText');
    
    let currentMovies = []; // 存储当前搜索结果
    
    // 订阅系列表单提交
    subscriptionForm.addEventListener('submit', function(e) {
        e.preventDefault();
        subscribeToSeries();
    });
    
    // 查看订阅列表
    viewSubscriptionsBtn.addEventListener('click', function() {
        loadSubscriptions();
        const modal = new bootstrap.Modal(subscriptionsModal);
        modal.show();
    });
    
    // 手动触发订阅检查 - 添加事件监听器
    if (triggerCheckBtn) {
        triggerCheckBtn.addEventListener('click', function() {
            triggerSubscriptionCheck();
        });
    }
    
    // 爬虫功能按钮事件监听器
    if (crawlAllStarBtn) {
        crawlAllStarBtn.addEventListener('click', function() {
            crawlAllStar();
        });
    }
    
    if (crawlTopStarBtn) {
        crawlTopStarBtn.addEventListener('click', function() {
            crawlTopStar();
        });
    }
    
    // 移动端按钮事件监听器
    if (crawlAllStarBtnMobile) {
        crawlAllStarBtnMobile.addEventListener('click', function() {
            crawlAllStar();
        });
    }
    
    if (crawlTopStarBtnMobile) {
        crawlTopStarBtnMobile.addEventListener('click', function() {
            crawlTopStar();
        });
    }
    
    if (triggerCheckBtnMobile) {
        triggerCheckBtnMobile.addEventListener('click', function() {
            triggerSubscriptionCheck();
        });
    }
    
    // 备份图片按钮事件监听器
    if (backupImagesBtn) {
        backupImagesBtn.addEventListener('click', function() {
            backupImages();
        });
    }
    
    if (backupImagesBtnMobile) {
        backupImagesBtnMobile.addEventListener('click', function() {
            backupImages();
        });
    }
    
    // 重试失败电影按钮事件监听器
    if (retryFailedMoviesBtn) {
        retryFailedMoviesBtn.addEventListener('click', function() {
            retryFailedMovies();
        });
    }
    
    if (retryFailedMoviesBtnMobile) {
        retryFailedMoviesBtnMobile.addEventListener('click', function() {
            retryFailedMovies();
        });
    }
    
    // 重试失败图片按钮事件监听器
    if (retryFailedImagesBtn) {
        retryFailedImagesBtn.addEventListener('click', function() {
            retryFailedImages();
        });
    }
    
    if (retryFailedImagesBtnMobile) {
        retryFailedImagesBtnMobile.addEventListener('click', function() {
            retryFailedImages();
        });
    }
    
    // 更新JAV首页按钮事件监听器
    if (updateJavHomeBtn) {
        updateJavHomeBtn.addEventListener('click', function() {
            updateJavHome();
        });
    }
    
    if (updateJavHomeBtnMobile) {
        updateJavHomeBtnMobile.addEventListener('click', function() {
            updateJavHome();
        });
    }
    
    // 订阅电影系列
    async function subscribeToSeries() {
        const seriesName = seriesNameInput.value.trim();
        if (!seriesName) return;
        
        // 显示加载状态
        subscriptionStatus.classList.remove('d-none');
        subscribeSeriesBtn.disabled = true;
        
        try {
            const response = await fetch('/api/subscribe-series', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    series_name: seriesName
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // 显示成功提示
                showToast('订阅成功！系统将每天晚上自动检查新电影', 'success');
                seriesNameInput.value = '';
            } else {
                showToast(data.error || '订阅失败', 'error');
            }
        } catch (err) {
            console.error('订阅错误:', err);
            showToast('网络错误，请稍后重试', 'error');
        } finally {
            subscriptionStatus.classList.add('d-none');
            subscribeSeriesBtn.disabled = false;
        }
    }
    
    // 加载订阅列表
    async function loadSubscriptions() {
        subscriptionsContent.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div><p class="mt-2">加载中...</p></div>';
        
        try {
            const response = await fetch('/api/subscriptions');
            const data = await response.json();
            
            if (data.success) {
                displaySubscriptions(data.subscriptions);
            } else {
                subscriptionsContent.innerHTML = '<div class="alert alert-danger">加载订阅列表失败: ' + (data.error || '未知错误') + '</div>';
            }
        } catch (err) {
            console.error('加载订阅列表错误:', err);
            subscriptionsContent.innerHTML = '<div class="alert alert-danger">网络错误，请稍后重试</div>';
        }
    }
    
    // 显示订阅列表
    function displaySubscriptions(subscriptions) {
        if (subscriptions.length === 0) {
            subscriptionsContent.innerHTML = '<div class="alert alert-info"><i class="bi bi-info-circle"></i> 暂无订阅的电影系列</div>';
            return;
        }
        
        let html = '<div class="list-group">';
        subscriptions.forEach(sub => {
            const createdDate = new Date(sub.created_at).toLocaleDateString('zh-CN');
            const lastChecked = sub.last_checked ? new Date(sub.last_checked).toLocaleDateString('zh-CN') : '未检查';
            
            html += `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1"><i class="bi bi-film"></i> ${sub.series_name}</h6>
                            <p class="mb-1 text-muted"><i class="bi bi-calendar"></i> 订阅时间: ${createdDate}</p>
                            <small class="text-muted"><i class="bi bi-clock"></i> 最后检查: ${lastChecked}</small>
                            ${sub.total_movies_found ? `<br><small class="text-success"><i class="bi bi-check-circle"></i> 已发现 ${sub.total_movies_found} 部电影</small>` : ''}
                        </div>
                        <div>
                            <span class="badge ${sub.status === 'active' ? 'bg-success' : 'bg-secondary'} me-2">
                                ${sub.status === 'active' ? '活跃' : '暂停'}
                            </span>
                            <button class="btn btn-sm btn-outline-danger" 
                                    onclick="removeSubscription('${sub._id}')" 
                                    title="删除订阅">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        
        subscriptionsContent.innerHTML = html;
    }
    
    // 全局函数：删除订阅
    window.removeSubscription = async function(subscriptionId) {
        if (!confirm('确定要删除这个订阅吗？')) return;
        
        try {
            const response = await fetch(`/api/subscriptions/${subscriptionId}`, {
                method: 'DELETE'
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast('订阅已删除', 'success');
                loadSubscriptions(); // 重新加载列表
            } else {
                showToast(data.error || '删除失败', 'error');
            }
        } catch (err) {
            console.error('删除订阅错误:', err);
            showToast('网络错误，请稍后重试', 'error');
        }
    };
    
    // 显示提示消息
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = 'toast-notification';
        const bgColor = type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8';
        const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle';
        
        toast.innerHTML = `<i class="bi bi-${icon}"></i> ${message}`;
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${bgColor};
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            z-index: 9999;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            max-width: 300px;
        `;
        document.body.appendChild(toast);
        setTimeout(() => {
            if (document.body.contains(toast)) {
                document.body.removeChild(toast);
            }
        }, 3000);
    }
    
    // 爬虫功能函数
    async function crawlAllStar() {
        if (!confirm('确定要开始更新全部演员电影吗？这可能需要较长时间。')) return;
        
        // 显示加载状态
        crawlerStatus.classList.remove('d-none');
        crawlerStatusText.textContent = '正在更新全部演员电影...';
        if (crawlAllStarBtn) crawlAllStarBtn.disabled = true;
        if (crawlAllStarBtnMobile) crawlAllStarBtnMobile.disabled = true;
        
        try {
            const response = await fetch('/api/crawl-all-star', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast(data.message, 'success');
            } else {
                showToast(data.error || '启动失败', 'error');
            }
        } catch (err) {
            console.error('更新全部演员电影错误:', err);
            showToast('网络错误，请稍后重试', 'error');
        } finally {
            crawlerStatus.classList.add('d-none');
            if (crawlAllStarBtn) crawlAllStarBtn.disabled = false;
            if (crawlAllStarBtnMobile) crawlAllStarBtnMobile.disabled = false;
        }
    }
    
    async function crawlTopStar() {
        if (!confirm('确定要开始更新热门演员吗？这可能需要较长时间。')) return;
        
        // 显示加载状态
        crawlerStatus.classList.remove('d-none');
        crawlerStatusText.textContent = '正在更新热门演员...';
        if (crawlTopStarBtn) crawlTopStarBtn.disabled = true;
        if (crawlTopStarBtnMobile) crawlTopStarBtnMobile.disabled = true;
        
        try {
            const response = await fetch('/api/crawl-top-star', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast(data.message, 'success');
            } else {
                showToast(data.error || '启动失败', 'error');
            }
        } catch (err) {
            console.error('更新热门演员错误:', err);
            showToast('网络错误，请稍后重试', 'error');
        } finally {
            crawlerStatus.classList.add('d-none');
            if (crawlTopStarBtn) crawlTopStarBtn.disabled = false;
            if (crawlTopStarBtnMobile) crawlTopStarBtnMobile.disabled = false;
        }
    }
    
    // 搜索表单提交
    searchForm.addEventListener('submit', function(e) {
        e.preventDefault();
        searchMovies();
    });
    
    // 全选/取消全选 - 修复：只选择未禁用的复选框
    selectAllCheckbox.addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.movie-checkbox:not(:disabled)');
        checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateSelectedCount();
    });
    
    // 更新选中数量
    function updateSelectedCount() {
        const selectedCheckboxes = document.querySelectorAll('.movie-checkbox:checked');
        const count = selectedCheckboxes.length;
        selectedCountSpan.textContent = count;
        subscribeBtn.disabled = count === 0;
        
        // 更新全选状态 - 修复：只考虑未禁用的复选框
        const enabledCheckboxes = document.querySelectorAll('.movie-checkbox:not(:disabled)');
        const selectedEnabledCheckboxes = document.querySelectorAll('.movie-checkbox:not(:disabled):checked');
        
        if (enabledCheckboxes.length > 0) {
            selectAllCheckbox.checked = selectedEnabledCheckboxes.length === enabledCheckboxes.length;
            selectAllCheckbox.indeterminate = selectedEnabledCheckboxes.length > 0 && selectedEnabledCheckboxes.length < enabledCheckboxes.length;
        }
    }
    
    // 搜索电影
    async function searchMovies() {
        const movieName = movieNameInput.value.trim();
        if (!movieName) return;
        
        // 显示加载状态
        loading.classList.remove('d-none');
        results.classList.add('d-none');
        error.classList.add('d-none');
        searchBtn.disabled = true;
        
        try {
            const response = await fetch('/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    movie_name: movieName
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                currentMovies = data.result.movies || [];
                displayResults(data.result);
            } else {
                showError(data.error || '搜索失败');
            }
        } catch (err) {
            console.error('搜索错误:', err);
            showError('网络错误，请稍后重试');
        } finally {
            loading.classList.add('d-none');
            searchBtn.disabled = false;
        }
    }
    
    // 显示错误
    function showError(message) {
        errorMessage.textContent = message;
        error.classList.remove('d-none');
        results.classList.add('d-none');
    }
    
    // 显示搜索结果 - 优化布局
    function displayResults(result) {
        let html = '';
        
        // 显示统计信息
        if (result.total_movies > 0) {
            resultStats.innerHTML = `共找到 ${result.total_movies} 部电影`;
            
            // 显示爬虫信息
            if (result.crawler_info) {
                html += `
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-info-circle"></i>
                        <strong>爬取信息:</strong> 
                        共爬取 ${result.crawler_info.total_pages_crawled} 页，
                        找到 ${result.crawler_info.total_movies_found} 部电影
                    </div>
                `;
            }
            
            // 显示电影列表 - 优化布局
            result.movies.forEach((movie, index) => {
                const jellyfinStatus = movie.jellyfin_exists ? 
                    '<span class="badge bg-success"><i class="bi bi-check-circle"></i> 已存在</span>' :
                    '<span class="badge bg-secondary"><i class="bi bi-x-circle"></i> 未找到</span>';
                
                // 构建标签数组
                const movieTags = [];
                if (movie.has_hd) movieTags.push('<span class="badge bg-primary">高清</span>');
                if (movie.has_subtitle) movieTags.push('<span class="badge bg-warning text-dark">字幕</span>');
                
                // 添加磁力链接标识
                const magnetStatus = movie.has_magnet ? 
                    '<span class="badge bg-success"><i class="bi bi-magnet"></i> 有磁力链接</span>' :
                    '<span class="badge bg-light text-muted"><i class="bi bi-x-circle"></i> 无磁力链接</span>';
                
                html += `
                    <div class="movie-item">
                        <div class="row align-items-start">
                            <div class="col-md-1 col-sm-1 d-flex align-items-center justify-content-center">
                                <div class="form-check">
                                    <input class="form-check-input movie-checkbox" type="checkbox" 
                                           id="movie-${index}" data-index="${index}" 
                                           ${movie.has_magnet ? '' : 'disabled'}
                                           onchange="updateSelectedCount()">
                                    <label class="form-check-label" for="movie-${index}"></label>
                                </div>
                            </div>
                            <div class="col-md-2 col-sm-3 d-flex align-items-center justify-content-center mb-3" style="min-height: 160px;">
                                ${movie.image_url ? 
                                    `<img src="${movie.image_url}" alt="${movie.title}" class="movie-image img-fluid" 
                                         style="max-width: 120px; max-height: 160px; object-fit: cover;"
                                         onerror="console.log('图片加载失败 URL:', this.src); this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjE2MCIgdmlld0JveD0iMCAwIDEyMCAxNjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjAiIGhlaWdodD0iMTYwIiBmaWxsPSIjRjhGOUZBIi8+CjxwYXRoIGQ9Ik00MCA2MEw4MCA2MEw2MCA5MEw0MCA2MFoiIGZpbGw9IiNEMUQ1REIiLz4KPC9zdmc+'">` :
                                    `<div class="movie-image d-flex align-items-center justify-content-center bg-light text-muted" style="width:120px;height:160px; border-radius: 8px;">
                                        <i class="bi bi-film" style="font-size: 2rem;"></i>
                                    </div>`
                                }
                            </div>
                            <div class="col-md-9 col-sm-8">
                                <div class="movie-info">
                                    <!-- 优化的标题和状态布局 -->
                                    <div class="movie-header">
                                        <p class="movie-title mb-0" style="font-size: 0.9rem;">
                                            ${movie.title || '未知标题'}
                                        </p>
                                        ${jellyfinStatus}
                                    </div>
                                    
                                    <!-- 优化的元数据布局 -->
                                    <div class="movie-meta">
                                        <span class="badge bg-info">编号: ${movie.movie_code || 'N/A'}</span>
                                        ${movie.release_date ? 
                                            `<span class="badge bg-secondary">发布: ${movie.release_date}</span>` : ''
                                        }
                                        ${magnetStatus}
                                        ${movieTags.join('')}
                                    </div>
                                    
                                    ${movie.has_magnet && movie.magnet_link ? 
                                        `<div class="magnet-link-container">
                                            <small class="text-muted d-block mb-1"><i class="bi bi-magnet"></i> 磁力链接:</small>
                                            <div class="input-group input-group-sm">
                                                <input type="text" class="form-control" value="${movie.magnet_link}" readonly>
                                                <button class="btn btn-outline-secondary" type="button" 
                                                        onclick="copyToClipboard('${movie.magnet_link.replace(/'/g, "\\'")}')" 
                                                        title="复制磁力链接">
                                                    <i class="bi bi-copy"></i>
                                                </button>
                                            </div>
                                        </div>` : ''
                                    }
                                    
                                    <div class="movie-actions mt-2">
                                        ${movie.movie_url ? 
                                            `<a href="${movie.movie_url}" target="_blank" class="btn btn-sm btn-outline-primary me-2">
                                                <i class="bi bi-box-arrow-up-right"></i> 查看详情
                                            </a>` : ''
                                        }
                                        
                                        ${movie.jellyfin_exists && movie.jellyfin_details && movie.jellyfin_details.length > 0 ? 
                                            `<button class="btn btn-sm btn-success" onclick="showJellyfinDetails(${index})">
                                                <i class="bi bi-info-circle"></i> Jellyfin详情
                                            </button>` : ''
                                        }
                                    </div>
                                    
                                    ${movie.jellyfin_exists && movie.jellyfin_details ? 
                                        `<div id="jellyfin-details-${index}" class="jellyfin-details mt-2 d-none">
                                            <div class="alert alert-success">
                                                <strong>Jellyfin中的信息:</strong><br>
                                                ${movie.jellyfin_details.map(detail => 
                                                    `<div class="mb-1">
                                                        <strong>${detail.name}</strong> (${detail.year || 'N/A'})<br>
                                                        <small class="text-muted">库: ${detail.library} | 路径: ${detail.path || 'N/A'}</small>
                                                    </div>`
                                                ).join('')}
                                            </div>
                                        </div>` : ''
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        } else {
            html = `
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>未找到电影:</strong> "${result.search_term || movieNameInput.value}"
                </div>
                <p class="text-muted">建议:</p>
                <ul class="text-muted">
                    <li>检查搜索关键词拼写</li>
                    <li>尝试使用不同的关键词</li>
                    <li>使用完整的系列URL进行搜索</li>
                </ul>
            `;
        }
        
        resultsContent.innerHTML = html;
        results.classList.remove('d-none');
        
        // 重置选择状态
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
        updateSelectedCount();
    }
    
    // 全局函数：显示Jellyfin详情
    window.showJellyfinDetails = function(index) {
        const detailsDiv = document.getElementById(`jellyfin-details-${index}`);
        if (detailsDiv) {
            detailsDiv.classList.toggle('d-none');
        }
    };
    
    // 全局函数：复制到剪贴板
    window.copyToClipboard = function(text) {
        navigator.clipboard.writeText(text).then(function() {
            // 显示简单提示
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.innerHTML = '<i class="bi bi-check-circle"></i> 已复制到剪贴板';
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 10px 15px;
                border-radius: 5px;
                z-index: 9999;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            `;
            document.body.appendChild(toast);
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 2000);
        }, function(err) {
            console.error('复制失败: ', err);
            alert('复制失败，请手动复制');
        });
    };
    
    // 全局函数：订阅选中的电影
    window.subscribeSelected = function() {
        const selectedCheckboxes = document.querySelectorAll('.movie-checkbox:checked');
        const magnetLinks = [];
        
        selectedCheckboxes.forEach(checkbox => {
            const index = parseInt(checkbox.dataset.index);
            const movie = currentMovies[index];
            if (movie && movie.magnet_link) {
                magnetLinks.push(movie.magnet_link);
            }
        });
        
        if (magnetLinks.length > 0) {
            const allLinks = magnetLinks.join('\n');
            navigator.clipboard.writeText(allLinks).then(function() {
                // 显示成功模态框
                document.getElementById('successMessage').textContent = `已复制 ${magnetLinks.length} 个磁力链接到剪贴板`;
                const modal = new bootstrap.Modal(document.getElementById('successModal'));
                modal.show();
                
                // 清除选择
                selectedCheckboxes.forEach(checkbox => {
                    checkbox.checked = false;
                });
                selectAllCheckbox.checked = false;
                updateSelectedCount();
            }, function(err) {
                console.error('复制失败: ', err);
                alert('复制失败，请手动复制');
            });
        }
    };
    
    // 全局函数：更新选中数量（供HTML调用）
    window.updateSelectedCount = updateSelectedCount;
    
    // 手动触发订阅检查函数 - 移到script标签内
    function triggerSubscriptionCheck() {
        const triggerBtn = document.getElementById('triggerCheckBtn');
        const originalText = triggerBtn.innerHTML;
        
        // 显示加载状态
        triggerBtn.disabled = true;
        triggerBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 检查中...';
        
        fetch('/api/trigger-subscription-check', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('订阅检查已开始执行，请查看控制台日志了解进度', 'success');
                // 5秒后恢复按钮状态
                setTimeout(() => {
                    triggerBtn.disabled = false;
                    triggerBtn.innerHTML = originalText;
                }, 5000);
            } else {
                showToast('触发订阅检查失败: ' + data.error, 'error');
                triggerBtn.disabled = false;
                triggerBtn.innerHTML = originalText;
            }
        })
        .catch(error => {
            console.error('触发订阅检查时出错:', error);
            showToast('触发订阅检查时出错', 'error');
            triggerBtn.disabled = false;
            triggerBtn.innerHTML = originalText;
        });
    }
    
    // 备份图片功能函数
    async function backupImages() {
        if (!confirm('确定要开始备份图片吗？这可能需要较长时间。')) return;
        
        // 显示加载状态
        crawlerStatus.classList.remove('d-none');
        crawlerStatusText.textContent = '正在备份图片...';
        if (backupImagesBtn) backupImagesBtn.disabled = true;
        if (backupImagesBtnMobile) backupImagesBtnMobile.disabled = true;
        
        try {
            const response = await fetch('/api/backup-images', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast(data.message, 'success');
            } else {
                showToast(data.error || '启动失败', 'error');
            }
        } catch (err) {
            console.error('备份图片错误:', err);
            showToast('网络错误，请稍后重试', 'error');
        } finally {
            crawlerStatus.classList.add('d-none');
            if (backupImagesBtn) backupImagesBtn.disabled = false;
            if (backupImagesBtnMobile) backupImagesBtnMobile.disabled = false;
        }
    }
    
    // 重试失败电影功能函数
    async function retryFailedMovies() {
        if (!confirm('确定要重试失败的电影吗？这将重新处理所有失败的 URL。')) return;
        
        // 显示加载状态
        crawlerStatus.classList.remove('d-none');
        crawlerStatusText.textContent = '正在重试失败的电影...';
        if (retryFailedMoviesBtn) retryFailedMoviesBtn.disabled = true;
        if (retryFailedMoviesBtnMobile) retryFailedMoviesBtnMobile.disabled = true;
        
        try {
            const response = await fetch('/api/retry-failed-movies', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast(data.message, 'success');
            } else {
                showToast(data.error || '启动失败', 'error');
            }
        } catch (err) {
            console.error('重试失败电影错误:', err);
            showToast('网络错误，请稍后重试', 'error');
        } finally {
            crawlerStatus.classList.add('d-none');
            if (retryFailedMoviesBtn) retryFailedMoviesBtn.disabled = false;
            if (retryFailedMoviesBtnMobile) retryFailedMoviesBtnMobile.disabled = false;
        }
    }
    
    // 重试失败图片功能函数
    async function retryFailedImages() {
        if (!confirm('确定要重试失败的图片下载吗？这将重新下载所有失败的图片。')) return;
        
        // 显示加载状态
        crawlerStatus.classList.remove('d-none');
        crawlerStatusText.textContent = '正在重试失败的图片...';
        if (retryFailedImagesBtn) retryFailedImagesBtn.disabled = true;
        if (retryFailedImagesBtnMobile) retryFailedImagesBtnMobile.disabled = true;
        
        try {
            const response = await fetch('/api/retry-failed-images', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast(data.message, 'success');
            } else {
                showToast(data.error || '启动失败', 'error');
            }
        } catch (err) {
            console.error('重试失败图片错误:', err);
            showToast('网络错误，请稍后重试', 'error');
        } finally {
            crawlerStatus.classList.add('d-none');
            if (retryFailedImagesBtn) retryFailedImagesBtn.disabled = false;
            if (retryFailedImagesBtnMobile) retryFailedImagesBtnMobile.disabled = false;
        }
    }
});


    // 更新论坛电影按钮事件监听器
    if (updateSehuatangBtn) {
        updateSehuatangBtn.addEventListener('click', function() {
            updateSehuatang();
        });
    }
    
    if (updateSehuatangBtnMobile) {
        updateSehuatangBtnMobile.addEventListener('click', function() {
            updateSehuatang();
        });
    }
    
    // 更新论坛电影功能函数
    async function updateSehuatang() {
        if (!confirm('确定要开始更新论坛电影吗？这可能需要较长时间。')) return;
        
        // 显示加载状态
        crawlerStatus.classList.remove('d-none');
        crawlerStatusText.textContent = '正在更新论坛电影...';
        if (updateSehuatangBtn) updateSehuatangBtn.disabled = true;
        if (updateSehuatangBtnMobile) updateSehuatangBtnMobile.disabled = true;
        
        try {
            const response = await fetch('/api/update-sehuatang', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast(data.message, 'success');
            } else {
                showToast(data.error || '启动失败', 'error');
            }
        } catch (err) {
            console.error('更新论坛电影错误:', err);
            showToast('网络错误，请稍后重试', 'error');
        } finally {
            crawlerStatus.classList.add('d-none');
            if (updateSehuatangBtn) updateSehuatangBtn.disabled = false;
            if (updateSehuatangBtnMobile) updateSehuatangBtnMobile.disabled = false;
        }
    }
    
    // 更新JAV首页功能函数
    async function updateJavHome() {
        if (!confirm('确定要开始更新JAV首页吗？这可能需要较长时间。')) return;
        
        // 显示加载状态
        crawlerStatus.classList.remove('d-none');
        crawlerStatusText.textContent = '正在更新JAV首页...';
        if (updateJavHomeBtn) updateJavHomeBtn.disabled = true;
        if (updateJavHomeBtnMobile) updateJavHomeBtnMobile.disabled = true;
        
        try {
            const response = await fetch('/api/update-jav-home', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                showToast(data.message, 'success');
            } else {
                showToast(data.error || '启动失败', 'error');
            }
        } catch (err) {
            console.error('更新JAV首页错误:', err);
            showToast('网络错误，请稍后重试', 'error');
        } finally {
            crawlerStatus.classList.add('d-none');
            if (updateJavHomeBtn) updateJavHomeBtn.disabled = false;
            if (updateJavHomeBtnMobile) updateJavHomeBtnMobile.disabled = false;
        }
    }

</script>


</script>
{% endblock %}
