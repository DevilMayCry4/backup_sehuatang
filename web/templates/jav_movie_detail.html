<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>影片</title>
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/bootstrap-icons.css') }}" rel="stylesheet">
     <link href="{{ url_for('static', filename='css/video-js.css') }}" rel="stylesheet"> 
    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/hls.js@latest') }}"></script>
    <script src="{{ url_for('static', filename='js/video.min.js') }}"></script>
    <style>
        body {
            background-color: #f8f9fa;
        }
        .mobile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .movie-poster {
            max-width: 100%;
            height: auto;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        .info-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
        }
        .btn-back {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            border-radius: 20px;
        }
         /* 播放按钮悬浮动画效果 */
        .play-button {
            transition: all 0.3s ease-in-out;
            transform: scale(1);
        }

        .play-button:hover {
            transform: scale(1.1);
            background: rgba(255,255,255,1) !important;
            border: 2px solid rgba(102, 126, 234, 0.8) !important;
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.3) !important;
        }
        
        .play-button:hover .bi-play-fill {
            transform: scale(1.2);
            color: #667eea !important;
        }
        
        .play-button:hover span {
            color: #667eea !important;
        }
        
        .play-button:active {
            transform: scale(0.95);
        }
        
        /* 播放图标脉冲动画 */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .play-button:hover .bi-play-fill {
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body>
    <!-- 头部导航 -->
    <div class="mobile-header">
        <div class="container">
            <div class="d-flex align-items-center">
                <h5 class="mb-0 text-center">{{ movie.title }}的影片</h5>
            </div>
        </div>
    </div>

    <div class="container mt-3">
        <!-- 影片海报 -->
        <div class="text-center mb-4 position-relative">
            <img src="{{ url_for('static', filename='images/covers/' + movie.code+'/'+movie.code+'_cover.jpg') }}" class="movie-poster" alt="{{ movie.title }}" 
                 >
            
            <!-- 播放按钮 - 悬浮在封面图上 -->
            {% if movie.is_exist %}
            <div class="position-absolute top-50 start-50 translate-middle">
                <button class="btn btn-light btn-lg shadow-lg play-button" onclick="playJellyfinVideo('{{ itemId }}')" 
                        style="border-radius: 50px; padding: 12px 30px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border: 2px solid rgba(255,255,255,0.8); transition: all 0.3s ease-in-out;">
                    <i class="bi bi-play-fill text-primary" style="font-size: 1.5rem; transition: all 0.3s ease-in-out;"></i>
                    <span class="ms-2 text-dark fw-bold" style="transition: all 0.3s ease-in-out;">播放影片</span>
                </button>
            </div>
            {% endif %}
        </div>

        <!-- 影片信息 -->
        <div class="info-card p-3">
            <h4 class="mb-3">{{ movie.title }}</h4>
            
            <div class="row mb-2">
                <div class="col-4 text-muted">番号:</div>
                <div class="col-8">{{ movie.code }}</div>
            </div>
            
            {% if movie.release_date %}
            <div class="row mb-2">
                <div class="col-4 text-muted">发行日期:</div>
                <div class="col-8">{{ movie.release_date }}</div>
            </div>
            {% endif %}
            
            {% if movie.duration %}
            <div class="row mb-2">
                <div class="col-4 text-muted">时长:</div>
                <div class="col-8">{{ movie.duration }}</div>
            </div>
            {% endif %}
            
            {% if movie.director %}
            <div class="row mb-2">
                <div class="col-4 text-muted">导演:</div>
                <div class="col-8">{{ movie.director }}</div>
            </div>
            {% endif %}
            
            {% if movie.studio %}
            <div class="row mb-2">
                <div class="col-4 text-muted">制作商:</div>
                <div class="col-8">
                    <a href="{{ url_for('studio_movies_page', studio_name=movie.studio) }}" 
                       class="text-decoration-none text-primary fw-bold">
                        {{ movie.studio }}
                    </a>
                </div>
            </div>
            {% endif %}
            
            {% if movie.series %}
            <div class="row mb-2">
                <div class="col-4 text-muted">系列:</div>
                <div class="col-8">
                    <a href="{{ url_for('series_movies_page', series_name=movie.series) }}" 
                       class="text-decoration-none text-primary fw-bold"
                       title="查看该系列的所有影片">
                        {{ movie.series }}
                    </a>
                </div>
            </div>
            {% endif %}

             
            
            {% if movie.genres %}
            <div class="row mb-2">
                <div class="col-4 text-muted">分类:</div>
                <div class="col-8">
                    {% for genre in movie.genres.split('\n') if genre.strip() %}
                        <span class="badge bg-secondary me-1 mb-1">{{ genre.strip() }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- 演员信息 -->
        {% if movie.actresses %}
        <div class="info-card p-3">
            <h5 class="mb-3">出演演员</h5>
            <div class="row">
                {% for actress_name in movie.actresses %}
                <div class="col-6 col-md-4 mb-2">
                    {% set actress_code = db_manager.get_actress_code_by_name(actress_name) %}
                    {% if actress_code %}
                        <a href="{{ url_for('actress_movies', code=actress_code) }}" 
                           class="text-decoration-none">
                            <span class="badge bg-primary">{{ actress_name }}</span>
                        </a>
                    {% else %}
                        <span class="badge bg-primary">{{ actress_name }}</span>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
   
        {% if movie.sehuatang_url %}
        <div class="info-card p-3">
            <h5 class="mb-3">色花堂磁力链接</h5>
            <div class="magnet-container mb-3 p-3 border rounded">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="d-flex align-items-center">
                        <h6 class="mb-0 me-2" style="word-break: break-all; line-height: 1.2; max-height: 2.4em; overflow: hidden;">{{'色花堂'}}</h6>
                        <!-- 字幕和高清图标 -->
                        <span class="badge bg-success me-1" title="包含字幕">
                            <i class="fas fa-closed-captioning"></i> 字幕
                        </span>
                        <span class="badge bg-info me-1" title="高清画质">
                            <i class="fas fa-video"></i> 高清
                        </span>
                    </div>
                    <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard('{{ movie.sehuatang_url }}')">复制</button>
                </div> 
                <div class="d-flex align-items-center">
                    <div class="text-break small bg-light p-2 rounded flex-grow-1" style="word-break: break-all; font-family: monospace;">
                        {{ movie.sehuatang_url }}
                    </div>
                    <button class="btn btn-sm btn-outline-success ms-2" onclick="addTo115('{{ movie.sehuatang_url }}')" title="添加到115网盘">
                        <i class="bi bi-cloud-plus"></i>
                    </button>
                </div>
            </div>
        </div>
        {%endif%}

        <!-- 磁力链接 -->
        {% if movie.magnet_links %}
        <div class="info-card p-3">
            <h5 class="mb-3">磁力链接</h5>
            {% for magnet in movie.magnet_links %}
            <div class="magnet-container mb-3 p-3 border rounded">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="d-flex align-items-center">
                        <h6 class="mb-0 me-2" style="word-break: break-all; line-height: 1.2; max-height: 2.4em; overflow: hidden;">{{ magnet.title or '未知标题' }}</h6>
                        <!-- 字幕和高清图标 -->
                        {% if magnet.title and ('字幕' in magnet.title or 'CH' in magnet.title or '中文' in magnet.title) %}
                        <span class="badge bg-success me-1" title="包含字幕">
                            <i class="fas fa-closed-captioning"></i> 字幕
                        </span>
                        {% endif %}
                        {% if magnet.title and ('HD' in magnet.title or '高清' in magnet.title or '1080' in magnet.title or '720' in magnet.title) %}
                        <span class="badge bg-info me-1" title="高清画质">
                            <i class="fas fa-video"></i> 高清
                        </span>
                        {% endif %}
                    </div>
                    <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard('{{ magnet.magnet }}')">复制</button>
                </div>
                
                <div class="row mb-2">
                    <div class="col-md-6">
                        <small class="text-muted">
                            <i class="fas fa-hdd"></i> 大小: {{ magnet.size or '未知大小' }}
                        </small>
                    </div>
                    <div class="col-md-6">
                        <small class="text-muted">
                            <i class="fas fa-calendar"></i> 日期: {{ magnet.date or '未知日期' }}
                        </small>
                    </div>
                </div>
                
                <div class="text-break small bg-light p-2 rounded" style="word-break: break-all; font-family: monospace;">
                        {{ magnet.magnet }}
                    </div>
                    <button class="btn btn-sm btn-outline-success ms-2" onclick="addTo115('{{ magnet.magnet }}')" title="添加到115网盘">
                        <i class="bi bi-cloud-plus"></i>
                    </button>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    
    <script>
        function copyToClipboard(text) {
            // 检查是否支持现代剪贴板API
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(function() {
                    showCopySuccess();
                }, function(err) {
                    console.error('复制失败: ', err);
                    fallbackCopyTextToClipboard(text);
                });
            } else {
                // 回退到传统方法
                fallbackCopyTextToClipboard(text);
            }
        }
        
        function fallbackCopyTextToClipboard(text) {
            var textArea = document.createElement("textarea");
            textArea.value = text;
            
            // 避免滚动到底部
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            textArea.style.opacity = "0";
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                var successful = document.execCommand('copy');
                if (successful) {
                    showCopySuccess();
                } else {
                    showCopyError();
                }
            } catch (err) {
                console.error('复制失败: ', err);
                showCopyError();
            }
            
            document.body.removeChild(textArea);
        }
        
        function showCopySuccess() {
            // 创建一个临时的成功提示
            var toast = document.createElement('div');
            toast.className = 'alert alert-success position-fixed';
            toast.style.top = '20px';
            toast.style.right = '20px';
            toast.style.zIndex = '9999';
            toast.style.minWidth = '300px';
            
            // 根据类型设置样式和图标
            let icon = '';
            let alertClass = '';
            
            alertClass = 'alert-success';
            icon = '<i class="fas fa-check"></i>';
            
            toast.className += ' ' + alertClass;
            toast.innerHTML = icon + ' ' + '复制成功';
            
            document.body.appendChild(toast);
            
            // 自动移除提示
            const duration = type === 'info' ? 2000 : 3000;
            setTimeout(function() {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, duration);
        }
        
        function showCopyError() {
            var toast = document.createElement('div');
            toast.className = 'alert alert-danger position-fixed';
            toast.style.top = '20px';
            toast.style.right = '20px';
            toast.style.zIndex = '9999';
            toast.innerHTML = '<i class="fas fa-exclamation-triangle"></i> 复制失败，请手动复制';
            
            document.body.appendChild(toast);
            
            setTimeout(function() {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
        }

        function addTo115(url){
            // 显示加载提示
            showToast('正在添加到115云下载...', 'info');
            
            // 获取电影编号
            const movieCode = '{{ movie.code }}';
            
            // 准备请求数据
            const requestData = {
                urls: [url],
                movie_code: movieCode,
                save_path: '' // 使用默认保存路径
            };
            
            // 发送请求到后端API
            fetch('/api/download/add-to-115', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('成功添加到115云下载！', 'success');
                    
                    // 可选：显示任务hash用于后续查询
                    if (data.task_hash) {
                        console.log('任务Hash:', data.task_hash);
                    }
                } else {
                    showToast('添加失败: ' + (data.error || '未知错误'), 'error');
                }
            })
            .catch(error => {
                console.error('添加到115云下载失败:', error);
                showToast('添加失败: 网络错误', 'error');
            });
        }
        
        function showToast(message, type = 'info') {
            // 创建toast元素
            var toast = document.createElement('div');
            toast.className = 'alert position-fixed';
            toast.style.top = '20px';
            toast.style.right = '20px';
            toast.style.zIndex = '9999';
            toast.style.minWidth = '300px';
            
            // 根据类型设置样式和图标
            let icon = '';
            let alertClass = '';
            
            switch(type) {
                case 'success':
                    alertClass = 'alert-success';
                    icon = '<i class="fas fa-check"></i>';
                    break;
                case 'error':
                    alertClass = 'alert-danger';
                    icon = '<i class="fas fa-exclamation-triangle"></i>';
                    break;
                case 'info':
                default:
                    alertClass = 'alert-info';
                    icon = '<i class="fas fa-info-circle"></i>';
                    break;
            }
            
            toast.className += ' ' + alertClass;
            toast.innerHTML = icon + ' ' + message;
            
            document.body.appendChild(toast);
            
            // 自动移除提示
            const duration = type === 'info' ? 2000 : 3000;
            setTimeout(function() {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, duration);
        }
        
        function playJellyfinVideo(itemId) {
            // 显示加载提示
            showToast('正在准备播放页面...', 'info');
            
            const serverUrl = "https://wudd.fun:8096";
            const apiKey = "8fe868dfd0064c32bc3e0bba6c554d2d";
            const deviceId = 'web-client';
            
            // 构建Jellyfin直接播放URL (使用标准API)
            const playbackUrl = `${serverUrl}/Videos/${itemId}/main.m3u8` + 
                `?api_key=${apiKey}` + 
                `&DeviceId=${deviceId}` +
                `&PlaySessionId=${Date.now()}` +
                `&VideoCodec=h264,hevc,vp9` +
                `&AudioCodec=aac,mp3,opus,flac` +
                `&VideoBitrate=20000000` +
                `&AudioBitrate=192000` +
                `&MaxAudioChannels=6` +
                `&MaxFramerate=60` +
                `&MaxWidth=1920` +
                `&MaxHeight=1080` +
                `&EnableDirectPlay=true` +
                `&EnableDirectStream=true` +
                `&SubtitleMethod=Embed`;
            
            // 构建播放页面URL并跳转
            const playerPageUrl = `/player?` + 
                `url=${encodeURIComponent(playbackUrl)}` +
                `&title=${encodeURIComponent('{{ movie.code }}')}` +
                `&poster=${encodeURIComponent('{{ url_for('static', filename='images/covers/' + movie.code + '/' + movie.code + '_cover.jpg') }}')}`;            
            
            // 在新标签页中打开播放页面
            window.open(playerPageUrl, '_blank');
        }
        
        function fallbackToApiPlayback(itemId) {
            // 使用后端API获取播放URL
            fetch(`/api/jellyfin/play-url/${itemId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.play_url) {
                        // 创建视频播放器模态框
                        createVideoModal(data.play_url, '{{ movie.code }}');
                    } else {
                        // 如果获取播放地址失败
                        showToast('获取Jellyfin播放地址失败: ' + (data.error || '未知错误'), 'error');
                    }
                })
                .catch(error => {
                    console.error('获取Jellyfin播放地址失败:', error);
                    showToast('获取Jellyfin播放地址失败: 网络错误', 'error');
                });
        }

        function playMovie115(movieCode) {
            if (jellyfin_result && jellyfin_result.success) {
                // 如果Jellyfin中存在影片，直接播放
                playVideo(jellyfin_result.item_id);
                return;
            }

            // 显示加载提示
            // showToast('正在获取播放地址...', 'info');
            
            // // 调用之前实现的playVideo函数（在base.html中定义）
            // if (typeof playVideo === 'function') {
            //     playVideo(movieCode);
            // } else {
            //     // 如果playVideo函数不存在，直接实现播放逻辑
            //     fetch(`/api/video/play-url/${movieCode}`)
            //         .then(response => response.json())
            //         .then(data => {
            //             if (data.success && data.play_url) {
            //                 // 创建视频播放器模态框
            //                 createVideoModal(data.play_url, movieCode);
            //             } else {
            //                 // 如果没有找到播放地址，尝试搜索115文件
            //                 searchAndPlay115Files(movieCode);
            //             }
            //         })
            //         .catch(error => {
            //             console.error('获取播放地址失败:', error);
            //             // 尝试搜索115文件
            //             searchAndPlay115Files(movieCode);
            //         });
            // }
        }
        
        function searchAndPlay115Files(movieCode) {
            showToast('正在搜索115文件...', 'info');
            
            fetch(`/api/video/search-115`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    keyword: movieCode,
                    file_type: 'video'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.files && data.files.length > 0) {
                    // 找到文件，获取第一个视频文件的播放地址
                    const videoFile = data.files.find(file => 
                        file.name.toLowerCase().includes('.mp4') || 
                        file.name.toLowerCase().includes('.mkv') || 
                        file.name.toLowerCase().includes('.avi')
                    ) || data.files[0];
                    
                    if (videoFile) {
                        getFilePlayUrl(videoFile.file_id, movieCode);
                    } else {
                        showToast('未找到可播放的视频文件', 'error');
                    }
                } else {
                    showToast('未找到相关视频文件', 'error');
                }
            })
            .catch(error => {
                console.error('搜索115文件失败:', error);
                showToast('搜索文件失败: 网络错误', 'error');
            });
        }
        
        function getFilePlayUrl(fileId, movieCode) {
            showToast('正在获取播放地址...', 'info');
            
            fetch('/api/video/get-play-url', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    file_id: fileId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.play_url) {
                    createVideoModal(data.play_url, movieCode);
                } else {
                    showToast('获取播放地址失败: ' + (data.error || '未知错误'), 'error');
                }
            })
            .catch(error => {
                console.error('获取播放地址失败:', error);
                showToast('获取播放地址失败: 网络错误', 'error');
            });
        }
        
        function createVideoModal(playUrl, movieCode) {
            // 移除现有的模态框
            const existingModal = document.getElementById('videoModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 创建模态框HTML
            const modalHtml = `
                <div class="modal fade" id="videoModal" tabindex="-1" aria-labelledby="videoModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="videoModalLabel">播放: ${movieCode}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body p-0">
                                <div class="ratio ratio-16x9">
                                    <video 
                                        id="videoPlayer" 
                                        controls 
                                        autoplay 
                                        class="w-100" 
                                        crossorigin="anonymous"
                                        controlsList="nodownload" 
                                        playsinline
                                        preload="auto"
                                    >
                                        <source src="${playUrl}" type="video/mp4">
                                        您的浏览器不支持视频播放。
                                    </video>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" id="fullscreenBtn" class="btn btn-primary">
                                    <i class="bi bi-fullscreen"></i> 全屏
                                </button>
                                <button type="button" id="playbackSpeedBtn" class="btn btn-secondary">
                                    1.0x
                                </button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 添加到页面
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // 显示模态框
            const videoModal = new bootstrap.Modal(document.getElementById('videoModal'));
            videoModal.show();
            
            // 获取视频元素
            const videoPlayer = document.getElementById('videoPlayer');
            
            // 全屏按钮功能
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            fullscreenBtn.addEventListener('click', () => {
                if (videoPlayer.requestFullscreen) {
                    videoPlayer.requestFullscreen();
                } else if (videoPlayer.webkitRequestFullscreen) {
                    videoPlayer.webkitRequestFullscreen();
                } else if (videoPlayer.msRequestFullscreen) {
                    videoPlayer.msRequestFullscreen();
                }
            });
            
            // 播放速度控制
            const playbackSpeedBtn = document.getElementById('playbackSpeedBtn');
            const speeds = [0.5, 0.75, 1.0, 1.25, 1.5, 2.0];
            let currentSpeedIndex = 2; // 默认1.0x
            
            playbackSpeedBtn.addEventListener('click', () => {
                currentSpeedIndex = (currentSpeedIndex + 1) % speeds.length;
                const newSpeed = speeds[currentSpeedIndex];
                videoPlayer.playbackRate = newSpeed;
                playbackSpeedBtn.textContent = `${newSpeed}x`;
            });
            
            // 模态框关闭时停止视频播放
            document.getElementById('videoModal').addEventListener('hidden.bs.modal', function () {
                videoPlayer.pause();
                videoPlayer.src = '';
                videoPlayer.load();
            });
            
            // 添加键盘快捷键
            document.addEventListener('keydown', handleKeyPress);
            
            function handleKeyPress(e) {
                if (!document.getElementById('videoModal')) return;
                
                switch(e.key) {
                    case ' ':
                        // 空格键暂停/播放
                        if (videoPlayer.paused) {
                            videoPlayer.play();
                        } else {
                            videoPlayer.pause();
                        }
                        e.preventDefault();
                        break;
                    case 'ArrowRight':
                        // 右箭头前进10秒
                        videoPlayer.currentTime += 10;
                        e.preventDefault();
                        break;
                    case 'ArrowLeft':
                        // 左箭头后退10秒
                        videoPlayer.currentTime -= 10;
                        e.preventDefault();
                        break;
                    case 'f':
                        // f键全屏
                        fullscreenBtn.click();
                        e.preventDefault();
                        break;
                }
            }
            
            // 模态框关闭时移除键盘事件监听
            document.getElementById('videoModal').addEventListener('hidden.bs.modal', function () {
                document.removeEventListener('keydown', handleKeyPress);
            });
        }

        function playMovie115(movieCode) {
            // 显示加载提示
            showToast('正在获取播放地址...', 'info');
            
            // 调用之前实现的playVideo函数（在base.html中定义）
            if (typeof playVideo === 'function') {
                playVideo(movieCode);
            } else {
                // 如果playVideo函数不存在，直接实现播放逻辑
                fetch(`/api/video/play-url/${movieCode}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.play_url) {
                            // 创建视频播放器模态框
                            createVideoModal(data.play_url, movieCode);
                        } else {
                            // 如果没有找到播放地址，尝试搜索115文件
                            searchAndPlay115Files(movieCode);
                        }
                    })
                    .catch(error => {
                        console.error('获取播放地址失败:', error);
                        // 尝试搜索115文件
                        searchAndPlay115Files(movieCode);
                    });
            }
        }
        
        function searchAndPlay115Files(movieCode) {
            showToast('正在搜索115文件...', 'info');
            
            fetch(`/api/video/search-115`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    keyword: movieCode,
                    file_type: 'video'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.files && data.files.length > 0) {
                    // 找到文件，获取第一个视频文件的播放地址
                    const videoFile = data.files.find(file => 
                        file.name.toLowerCase().includes('.mp4') || 
                        file.name.toLowerCase().includes('.mkv') || 
                        file.name.toLowerCase().includes('.avi')
                    ) || data.files[0];
                    
                    if (videoFile) {
                        getFilePlayUrl(videoFile.file_id, movieCode);
                    } else {
                        showToast('未找到可播放的视频文件', 'error');
                    }
                } else {
                    showToast('未找到相关视频文件', 'error');
                }
            })
            .catch(error => {
                console.error('搜索115文件失败:', error);
                showToast('搜索文件失败: 网络错误', 'error');
            });
        }
        
        function getFilePlayUrl(fileId, movieCode) {
            showToast('正在获取播放地址...', 'info');
            
            fetch('/api/video/get-play-url', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    file_id: fileId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.play_url) {
                    createVideoModal(data.play_url, movieCode);
                } else {
                    showToast('获取播放地址失败: ' + (data.error || '未知错误'), 'error');
                }
            })
            .catch(error => {
                console.error('获取播放地址失败:', error);
                showToast('获取播放地址失败: 网络错误', 'error');
            });
        }
        
        function createVideoModal(playUrl, movieCode) {
            // 移除现有的模态框
            const existingModal = document.getElementById('videoModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 创建模态框HTML
            const modalHtml = `
                <div class="modal fade" id="videoModal" tabindex="-1" aria-labelledby="videoModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="videoModalLabel">播放: ${movieCode}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body p-0">
                                <div class="ratio ratio-16x9">
                                    <video 
                                        id="videoPlayer" 
                                        controls 
                                        autoplay 
                                        class="w-100" 
                                        crossorigin="anonymous"
                                        controlsList="nodownload" 
                                        playsinline
                                        preload="auto"
                                    >
                                    
                                    </video>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" id="fullscreenBtn" class="btn btn-primary">
                                    <i class="bi bi-fullscreen"></i> 全屏
                                </button>
                                <button type="button" id="playbackSpeedBtn" class="btn btn-secondary">
                                    1.0x
                                </button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 添加到页面
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // 显示模态框
            const videoModal = new bootstrap.Modal(document.getElementById('videoModal'));
            videoModal.show();
            
            // 获取视频元素
            const videoPlayer = document.getElementById('videoPlayer');
            
            // 使用 hls.js 播放视频
            if (Hls.isSupported()) {
                const hls = new Hls({
                    maxBufferLength: 30,
                    maxMaxBufferLength: 60,
                    maxBufferSize: 60 * 1000 * 1000, // 60MB
                    maxBufferHole: 0.5,
                    lowLatencyMode: false,
                    debug: false
                });
                hls.loadSource(playUrl);
                hls.attachMedia(videoPlayer);
                hls.on(Hls.Events.MANIFEST_PARSED, function() {
                    videoPlayer.play();
                });
                
                // 错误处理
                hls.on(Hls.Events.ERROR, function(event, data) {
                    if (data.fatal) {
                        switch(data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                console.error('HLS 网络错误', data);
                                showToast('视频加载失败: 网络错误', 'error');
                                hls.startLoad(); // 尝试恢复
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                console.error('HLS 媒体错误', data);
                                showToast('视频播放错误: 媒体错误', 'error');
                                hls.recoverMediaError(); // 尝试恢复
                                break;
                            default:
                                console.error('HLS 致命错误', data);
                                showToast('视频播放错误: 无法恢复', 'error');
                                hls.destroy();
                                break;
                        }
                    }
                });
                
                // 模态框关闭时销毁 hls 实例
                document.getElementById('videoModal').addEventListener('hidden.bs.modal', function () {
                    hls.destroy();
                });
            } else if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                // 对于 Safari 等原生支持 HLS 的浏览器
                videoPlayer.src = playUrl;
                videoPlayer.addEventListener('loadedmetadata', function() {
                    videoPlayer.play();
                });
            } else {
                // 不支持 HLS，尝试直接播放
                showToast('您的浏览器不支持 HLS 播放，尝试直接播放', 'warning');
                videoPlayer.src = playUrl;
            }
        }

        function playMovie115(movieCode) {
            // 显示加载提示
            showToast('正在获取播放地址...', 'info');
            
            // 调用之前实现的playVideo函数（在base.html中定义）
            if (typeof playVideo === 'function') {
                playVideo(movieCode);
            } else {
                // 如果playVideo函数不存在，直接实现播放逻辑
                fetch(`/api/video/play-url/${movieCode}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.play_url) {
                            // 创建视频播放器模态框
                            createVideoModal(data.play_url, movieCode);
                        } else {
                            // 如果没有找到播放地址，尝试搜索115文件
                            searchAndPlay115Files(movieCode);
                        }
                    })
                    .catch(error => {
                        console.error('获取播放地址失败:', error);
                        // 尝试搜索115文件
                        searchAndPlay115Files(movieCode);
                    });
            }
        }
        
        function searchAndPlay115Files(movieCode) {
            showToast('正在搜索115文件...', 'info');
            
            fetch(`/api/video/search-115`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    keyword: movieCode,
                    file_type: 'video'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.files && data.files.length > 0) {
                    // 找到文件，获取第一个视频文件的播放地址
                    const videoFile = data.files.find(file => 
                        file.name.toLowerCase().includes('.mp4') || 
                        file.name.toLowerCase().includes('.mkv') || 
                        file.name.toLowerCase().includes('.avi')
                    ) || data.files[0];
                    
                    if (videoFile) {
                        getFilePlayUrl(videoFile.file_id, movieCode);
                    } else {
                        showToast('未找到可播放的视频文件', 'error');
                    }
                } else {
                    showToast('未找到相关视频文件', 'error');
                }
            })
            .catch(error => {
                console.error('搜索115文件失败:', error);
                showToast('搜索文件失败: 网络错误', 'error');
            });
        }
        
        function getFilePlayUrl(fileId, movieCode) {
            showToast('正在获取播放地址...', 'info');
            
            fetch('/api/video/get-play-url', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    file_id: fileId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.play_url) {
                    createVideoModal(data.play_url, movieCode);
                } else {
                    showToast('获取播放地址失败: ' + (data.error || '未知错误'), 'error');
                }
            })
            .catch(error => {
                console.error('获取播放地址失败:', error);
                showToast('获取播放地址失败: 网络错误', 'error');
            });
        }
        
        function createVideoModal(playUrl, movieCode) {
            // 移除现有的模态框
            const existingModal = document.getElementById('videoModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 创建模态框HTML
            const modalHtml = `
                <div class="modal fade" id="videoModal" tabindex="-1" aria-labelledby="videoModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="videoModalLabel">播放: ${movieCode}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body p-0">
                                <div class="ratio ratio-16x9">
                                    <video 
                                        id="videoPlayer" 
                                        class="video-js vjs-default-skin vjs-big-play-button vjs-fluid"
                                        controls 
                                        preload="auto"
                                        data-setup='{
                                            "fluid": true,
                                            "playbackRates": [0.5, 0.75, 1, 1.25, 1.5, 2],
                                            "controlBar": {
                                                "children": [
                                                    "playToggle",
                                                    "currentTimeDisplay",
                                                    "timeDivider",
                                                    "durationDisplay",
                                                    "progressControl",
                                                    "volumePanel",
                                                    "playbackRateMenuButton",
                                                    "fullscreenToggle"
                                                ]
                                            }
                                        }'
                                    >
                                    </video>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 添加到页面
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // 显示模态框
            const videoModal = new bootstrap.Modal(document.getElementById('videoModal'));
            videoModal.show();
            
            // 初始化 Video.js 播放器
            const player = videojs('videoPlayer', {
                sources: [{
                    src: playUrl,
                    type: 'video/mp4'
                }]
            });
            
            // 模态框关闭时销毁播放器
            document.getElementById('videoModal').addEventListener('hidden.bs.modal', function () {
                if (player) {
                    player.dispose();
                }
            });
            
            showToast('开始播放视频', 'success');
        }

        function playMovie115(movieCode) {
            // 显示加载提示
            showToast('正在获取播放地址...', 'info');
            
            // 调用之前实现的playVideo函数（在base.html中定义）
            if (typeof playVideo === 'function') {
                playVideo(movieCode);
            } else {
                // 如果playVideo函数不存在，直接实现播放逻辑
                fetch(`/api/video/play-url/${movieCode}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.play_url) {
                            // 创建视频播放器模态框
                            createVideoModal(data.play_url, movieCode);
                        } else {
                            // 如果没有找到播放地址，尝试搜索115文件
                            searchAndPlay115Files(movieCode);
                        }
                    })
                    .catch(error => {
                        console.error('获取播放地址失败:', error);
                        // 尝试搜索115文件
                        searchAndPlay115Files(movieCode);
                    });
            }
        }
        
        function searchAndPlay115Files(movieCode) {
            showToast('正在搜索115文件...', 'info');
            
            fetch(`/api/video/search-115`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    keyword: movieCode,
                    file_type: 'video'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.files && data.files.length > 0) {
                    // 找到文件，获取第一个视频文件的播放地址
                    const videoFile = data.files.find(file => 
                        file.name.toLowerCase().includes('.mp4') || 
                        file.name.toLowerCase().includes('.mkv') || 
                        file.name.toLowerCase().includes('.avi')
                    ) || data.files[0];
                    
                    if (videoFile) {
                        getFilePlayUrl(videoFile.file_id, movieCode);
                    } else {
                        showToast('未找到可播放的视频文件', 'error');
                    }
                } else {
                    showToast('未找到相关视频文件', 'error');
                }
            })
            .catch(error => {
                console.error('搜索115文件失败:', error);
                showToast('搜索文件失败: 网络错误', 'error');
            });
        }
        
        function getFilePlayUrl(fileId, movieCode) {
            showToast('正在获取播放地址...', 'info');
            
            fetch('/api/video/get-play-url', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    file_id: fileId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.play_url) {
                    createVideoModal(data.play_url, movieCode);
                } else {
                    showToast('获取播放地址失败: ' + (data.error || '未知错误'), 'error');
                }
            })
            .catch(error => {
                console.error('获取播放地址失败:', error);
                showToast('获取播放地址失败: 网络错误', 'error');
            });
        }
        
        function createVideoModal(playUrl, movieCode) {
            // 移除现有的模态框
            const existingModal = document.getElementById('videoModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 创建模态框HTML
            const modalHtml = `
                <div class="modal fade" id="videoModal" tabindex="-1" aria-labelledby="videoModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="videoModalLabel">播放: ${movieCode}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body p-0">
                                <div class="ratio ratio-16x9">
                                    <video controls autoplay class="w-100">
                                        <source src="${playUrl}" type="video/mp4">
                                        您的浏览器不支持视频播放。
                                    </video>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 添加到页面
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('videoModal'));
            modal.show();
            
            // 模态框关闭时清理
            document.getElementById('videoModal').addEventListener('hidden.bs.modal', function () {
                this.remove();
            });
            
            showToast('开始播放视频', 'success');
        }

        function playMovie115(movieCode) {
            // 显示加载提示
            showToast('正在获取播放地址...', 'info');
            
            // 调用之前实现的playVideo函数（在base.html中定义）
            if (typeof playVideo === 'function') {
                playVideo(movieCode);
            } else {
                // 如果playVideo函数不存在，直接实现播放逻辑
                fetch(`/api/video/play-url/${movieCode}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.play_url) {
                            // 创建视频播放器模态框
                            createVideoModal(data.play_url, movieCode);
                        } else {
                            // 如果没有找到播放地址，尝试搜索115文件
                            searchAndPlay115Files(movieCode);
                        }
                    })
                    .catch(error => {
                        console.error('获取播放地址失败:', error);
                        // 尝试搜索115文件
                        searchAndPlay115Files(movieCode);
                    });
            }
        }
        
        function searchAndPlay115Files(movieCode) {
            showToast('正在搜索115文件...', 'info');
            
            fetch(`/api/video/search-115`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    keyword: movieCode,
                    file_type: 'video'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.files && data.files.length > 0) {
                    // 找到文件，获取第一个视频文件的播放地址
                    const videoFile = data.files.find(file => 
                        file.name.toLowerCase().includes('.mp4') || 
                        file.name.toLowerCase().includes('.mkv') || 
                        file.name.toLowerCase().includes('.avi')
                    ) || data.files[0];
                    
                    if (videoFile) {
                        getFilePlayUrl(videoFile.file_id, movieCode);
                    } else {
                        showToast('未找到可播放的视频文件', 'error');
                    }
                } else {
                    showToast('未找到相关视频文件', 'error');
                }
            })
            .catch(error => {
                console.error('搜索115文件失败:', error);
                showToast('搜索文件失败: 网络错误', 'error');
            });
        }
        
        function getFilePlayUrl(fileId, movieCode) {
            showToast('正在获取播放地址...', 'info');
            
            fetch('/api/video/get-play-url', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    file_id: fileId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.play_url) {
                    createVideoModal(data.play_url, movieCode);
                } else {
                    showToast('获取播放地址失败: ' + (data.error || '未知错误'), 'error');
                }
            })
            .catch(error => {
                console.error('获取播放地址失败:', error);
                showToast('获取播放地址失败: 网络错误', 'error');
            });
        }
        
        function createVideoModal(playUrl, movieCode) {
            // 移除现有的模态框
            const existingModal = document.getElementById('videoModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 创建模态框HTML
            const modalHtml = `
                <div class="modal fade" id="videoModal" tabindex="-1" aria-labelledby="videoModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="videoModalLabel">播放: ${movieCode}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body p-0">
                                <div class="ratio ratio-16x9">
                                    <video controls autoplay class="w-100">
                                        <source src="${playUrl}" type="video/mp4">
                                        您的浏览器不支持视频播放。
                                    </video>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 添加到页面
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('videoModal'));
            modal.show();
            
            // 模态框关闭时清理
            document.getElementById('videoModal').addEventListener('hidden.bs.modal', function () {
                this.remove();
            });
            
            showToast('开始播放视频', 'success');
        }

        function playMovie115(movieCode) {
            // 显示加载提示
            showToast('正在获取播放地址...', 'info');
            
            // 调用之前实现的playVideo函数（在base.html中定义）
            if (typeof playVideo === 'function') {
                playVideo(movieCode);
            } else {
                // 如果playVideo函数不存在，直接实现播放逻辑
                fetch(`/api/video/play-url/${movieCode}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.play_url) {
                            // 创建视频播放器模态框
                            createVideoModal(data.play_url, movieCode);
                        } else {
                            // 如果没有找到播放地址，尝试搜索115文件
                            searchAndPlay115Files(movieCode);
                        }
                    })
                    .catch(error => {
                        console.error('获取播放地址失败:', error);
                        // 尝试搜索115文件
                        searchAndPlay115Files(movieCode);
                    });
            }
        }
        
        function searchAndPlay115Files(movieCode) {
            showToast('正在搜索115文件...', 'info');
            
            fetch(`/api/video/search-115`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    keyword: movieCode,
                    file_type: 'video'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.files && data.files.length > 0) {
                    // 找到文件，获取第一个视频文件的播放地址
                    const videoFile = data.files.find(file => 
                        file.name.toLowerCase().includes('.mp4') || 
                        file.name.toLowerCase().includes('.mkv') || 
                        file.name.toLowerCase().includes('.avi')
                    ) || data.files[0];
                    
                    if (videoFile) {
                        getFilePlayUrl(videoFile.file_id, movieCode);
                    } else {
                        showToast('未找到可播放的视频文件', 'error');
                    }
                } else {
                    showToast('未找到相关视频文件', 'error');
                }
            })
            .catch(error => {
                console.error('搜索115文件失败:', error);
                showToast('搜索文件失败: 网络错误', 'error');
            });
        }
        
        function getFilePlayUrl(fileId, movieCode) {
            showToast('正在获取播放地址...', 'info');
            
            fetch('/api/video/get-play-url', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    file_id: fileId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.play_url) {
                    createVideoModal(data.play_url, movieCode);
                } else {
                    showToast('获取播放地址失败: ' + (data.error || '未知错误'), 'error');
                }
            })
            .catch(error => {
                console.error('获取播放地址失败:', error);
                showToast('获取播放地址失败: 网络错误', 'error');
            });
        }
        
        function createVideoModal(playUrl, movieCode) {
            // 移除现有的模态框
            const existingModal = document.getElementById('videoModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 创建模态框HTML
            const modalHtml = `
                <div class="modal fade" id="videoModal" tabindex="-1" aria-labelledby="videoModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="videoModalLabel">播放: ${movieCode}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body p-0">
                                <div class="ratio ratio-16x9">
                                    <video controls autoplay class="w-100">
                                        <source src="${playUrl}" type="video/mp4">
                                        您的浏览器不支持视频播放。
                                    </video>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 添加到页面
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('videoModal'));
            modal.show();
            
            // 模态框关闭时清理
            document.getElementById('videoModal').addEventListener('hidden.bs.modal', function () {
                this.remove();
            });
            
            showToast('开始播放视频', 'success');
        }

        function playMovie115(movieCode) {
            // 显示加载提示
            showToast('正在获取播放地址...', 'info');
            
            // 调用之前实现的playVideo函数（在base.html中定义）
            if (typeof playVideo === 'function') {
                playVideo(movieCode);
            } else {
                // 如果playVideo函数不存在，直接实现播放逻辑
                fetch(`/api/video/play-url/${movieCode}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.play_url) {
                            // 创建视频播放器模态框
                            createVideoModal(data.play_url, movieCode);
                        } else {
                            // 如果没有找到播放地址，尝试搜索115文件
                            searchAndPlay115Files(movieCode);
                        }
                    })
                    .catch(error => {
                        console.error('获取播放地址失败:', error);
                        // 尝试搜索115文件
                        searchAndPlay115Files(movieCode);
                    });
            }
        }
        
        function searchAndPlay115Files(movieCode) {
            showToast('正在搜索115文件...', 'info');
            
            fetch(`/api/video/search-115`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    keyword: movieCode,
                    file_type: 'video'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.files && data.files.length > 0) {
                    // 找到文件，获取第一个视频文件的播放地址
                    const videoFile = data.files.find(file => 
                        file.name.toLowerCase().includes('.mp4') || 
                        file.name.toLowerCase().includes('.mkv') || 
                        file.name.toLowerCase().includes('.avi')
                    ) || data.files[0];
                    
                    if (videoFile) {
                        getFilePlayUrl(videoFile.file_id, movieCode);
                    } else {
                        showToast('未找到可播放的视频文件', 'error');
                    }
                } else {
                    showToast('未找到相关视频文件', 'error');
                }
            })
            .catch(error => {
                console.error('搜索115文件失败:', error);
                showToast('搜索文件失败: 网络错误', 'error');
            });
        }
        
        function getFilePlayUrl(fileId, movieCode) {
            showToast('正在获取播放地址...', 'info');
            
            fetch('/api/video/get-play-url', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    file_id: fileId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.play_url) {
                    createVideoModal(data.play_url, movieCode);
                } else {
                    showToast('获取播放地址失败: ' + (data.error || '未知错误'), 'error');
                }
            })
            .catch(error => {
                console.error('获取播放地址失败:', error);
                showToast('获取播放地址失败: 网络错误', 'error');
            });
        }
        
        function createVideoModal(playUrl, movieCode) {
            // 移除现有的模态框
            const existingModal = document.getElementById('videoModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 创建模态框HTML
            const modalHtml = `
                <div class="modal fade" id="videoModal" tabindex="-1" aria-labelledby="videoModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="videoModalLabel">播放: ${movieCode}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body p-0">
                                <div class="ratio ratio-16x9">
                                    <video controls autoplay class="w-100">
                                        <source src="${playUrl}" type="video/mp4">
                                        您的浏览器不支持视频播放。
                                    </video>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 添加到页面
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('videoModal'));
            modal.show();
            
            // 模态框关闭时清理
            document.getElementById('videoModal').addEventListener('hidden.bs.modal', function () {
                this.remove();
            });
            
            showToast('开始播放视频', 'success');
        }

        function playMovie115(movieCode) {
            // 显示加载提示
            showToast('正在获取播放地址...', 'info');
            
            // 调用之前实现的playVideo函数（在base.html中定义）
            if (typeof playVideo === 'function') {
                playVideo(movieCode);
            } else {
                // 如果playVideo函数不存在，直接实现播放逻辑
                fetch(`/api/video/play-url/${movieCode}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.play_url) {
                            // 创建视频播放器模态框
                            createVideoModal(data.play_url, movieCode);
                        } else {
                            // 如果没有找到播放地址，尝试搜索115文件
                            searchAndPlay115Files(movieCode);
                        }
                    })
                    .catch(error => {
                        console.error('获取播放地址失败:', error);
                        // 尝试搜索115文件
                        searchAndPlay115Files(movieCode);
                    });
            }
        }
        
        function searchAndPlay115Files(movieCode) {
            showToast('正在搜索115文件...', 'info');
            
            fetch(`/api/video/search-115`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    keyword: movieCode,
                    file_type: 'video'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.files && data.files.length > 0) {
                    // 找到文件，获取第一个视频文件的播放地址
                    const videoFile = data.files.find(file => 
                        file.name.toLowerCase().includes('.mp4') || 
                        file.name.toLowerCase().includes('.mkv') || 
                        file.name.toLowerCase().includes('.avi')
                    ) || data.files[0];
                    
                    if (videoFile) {
                        getFilePlayUrl(videoFile.file_id, movieCode);
                    } else {
                        showToast('未找到可播放的视频文件', 'error');
                    }
                } else {
                    showToast('未找到相关视频文件', 'error');
                }
            })
            .catch(error => {
                console.error('搜索115文件失败:', error);
                showToast('搜索文件失败: 网络错误', 'error');
            });
        }
        
        function getFilePlayUrl(fileId, movieCode) {
            showToast('正在获取播放地址...', 'info');
            
            fetch('/api/video/get-play-url', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    file_id: fileId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.play_url) {
                    createVideoModal(data.play_url, movieCode);
                } else {
                    showToast('获取播放地址失败: ' + (data.error || '未知错误'), 'error');
                }
            })
            .catch(error => {
                console.error('获取播放地址失败:', error);
                showToast('获取播放地址失败: 网络错误', 'error');
            });
        }
        
        function createVideoModal(playUrl, movieCode) {
            // 移除现有的模态框
            const existingModal = document.getElementById('videoModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 创建模态框HTML
            const modalHtml = `
                <div class="modal fade" id="videoModal" tabindex="-1" aria-labelledby="videoModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="videoModalLabel">播放: ${movieCode}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body p-0">
                                <div class="ratio ratio-16x9">
                                    <video controls autoplay class="w-100">
                                        <source src="${playUrl}" type="video/mp4">
                                        您的浏览器不支持视频播放。
                                    </video>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 添加到页面
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('videoModal'));
            modal.show();
            
            // 模态框关闭时清理
            document.getElementById('videoModal').addEventListener('hidden.bs.modal', function () {
                this.remove();
            });
            
            showToast('开始播放视频', 'success');
        }

        function playMovie115(movieCode) {
            // 显示加载提示
            showToast('正在获取播放地址...', 'info');
            
            // 调用之前实现的playVideo函数（在base.html中定义）
            if (typeof playVideo === 'function') {
                playVideo(movieCode);
            } else {
                // 如果playVideo函数不存在，直接实现播放逻辑
                fetch(`/api/video/play-url/${movieCode}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.play_url) {
                            // 创建视频播放器模态框
                            createVideoModal(data.play_url, movieCode);
                        } else {
                            // 如果没有找到播放地址，尝试搜索115文件
                            searchAndPlay115Files(movieCode);
                        }
                    })
                    .catch(error => {
                        console.error('获取播放地址失败:', error);
                        // 尝试搜索115文件
                        searchAndPlay115Files(movieCode);
                    });
            }
        }
        
        function searchAndPlay115Files(movieCode) {
            showToast('正在搜索115文件...', 'info');
            
            fetch(`/api/video/search-115`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    keyword: movieCode,
                    file_type: 'video'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.files && data.files.length > 0) {
                    // 找到文件，获取第一个视频文件的播放地址
                    const videoFile = data.files.find(file => 
                        file.name.toLowerCase().includes('.mp4') || 
                        file.name.toLowerCase().includes('.mkv') || 
                        file.name.toLowerCase().includes('.avi')
                    ) || data.files[0];
                    
                    if (videoFile) {
                        getFilePlayUrl(videoFile.file_id, movieCode);
                    } else {
                        showToast('未找到可播放的视频文件', 'error');
                    }
                } else {
                    showToast('未找到相关视频文件', 'error');
                }
            })
            .catch(error => {
                console.error('搜索115文件失败:', error);
                showToast('搜索文件失败: 网络错误', 'error');
            });
        }
        
        function getFilePlayUrl(fileId, movieCode) {
            showToast('正在获取播放地址...', 'info');
            
            fetch('/api/video/get-play-url', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    file_id: fileId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.play_url) {
                    createVideoModal(data.play_url, movieCode);
                } else {
                    showToast('获取播放地址失败: ' + (data.error || '未知错误'), 'error');
                }
            })
            .catch(error => {
                console.error('获取播放地址失败:', error);
                showToast('获取播放地址失败: 网络错误', 'error');
            });
        }
        
        function createVideoModal(playUrl, movieCode) {
            // 移除现有的模态框
            const existingModal = document.getElementById('videoModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 创建模态框HTML
            const modalHtml = `
                <div class="modal fade" id="videoModal" tabindex="-1" aria-labelledby="videoModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="videoModalLabel">播放: ${movieCode}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body p-0">
                                <div class="ratio ratio-16x9">
                                    <video controls autoplay class="w-100">
                                        <source src="${playUrl}" type="video/mp4">
                                        您的浏览器不支持视频播放。
                                    </video>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 添加到页面
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('videoModal'));
            modal.show();
            
            // 模态框关闭时清理
            document.getElementById('videoModal').addEventListener('hidden.bs.modal', function () {
                this.remove();
            });
            
            showToast('开始播放视频', 'success');
        }

        function playMovie115(movieCode) {
            // 显示加载提示
            showToast('正在获取播放地址...', 'info');
            
            // 调用之前实现的playVideo函数（在base.html中定义）
            if (typeof playVideo === 'function') {
                playVideo(movieCode);
            } else {
                // 如果playVideo函数不存在，直接实现播放逻辑
                fetch(`/api/video/play-url/${movieCode}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.play_url) {
                            // 创建视频播放器模态框
                            createVideoModal(data.play_url, movieCode);
                        } else {
                            // 如果没有找到播放地址，尝试搜索115文件
                            searchAndPlay115Files(movieCode);
                        }
                    })
                    .catch(error => {
                        console.error('获取播放地址失败:', error);
                        // 尝试搜索115文件
                        searchAndPlay115Files(movieCode);
                    });
            }
        }
        
        function searchAndPlay115Files(movieCode) {
            showToast('正在搜索115文件...', 'info');
            
            fetch(`/api/video/search-115`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    keyword: movieCode,
                    file_type: 'video'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.files && data.files.length > 0) {
                    // 找到文件，获取第一个视频文件的播放地址
                    const videoFile = data.files.find(file => 
                        file.name.toLowerCase().includes('.mp4') || 
                        file.name.toLowerCase().includes('.mkv') || 
                        file.name.toLowerCase().includes('.avi')
                    ) || data.files[0];
                    
                    if (videoFile) {
                        getFilePlayUrl(videoFile.file_id, movieCode);
                    } else {
                        showToast('未找到可播放的视频文件', 'error');
                    }
                } else {
                    showToast('未找到相关视频文件', 'error');
                }
            })
            .catch(error => {
                console.error('搜索115文件失败:', error);
                showToast('搜索文件失败: 网络错误', 'error');
            });
        }
        
        function getFilePlayUrl(fileId, movieCode) {
            showToast('正在获取播放地址...', 'info');
            
            fetch('/api/video/get-play-url', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    file_id: fileId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.play_url) {
                    createVideoModal(data.play_url, movieCode);
                } else {
                    showToast('获取播放地址失败: ' + (data.error || '未知错误'), 'error');
                }
            })
            .catch(error => {
                console.error('获取播放地址失败:', error);
                showToast('获取播放地址失败: 网络错误', 'error');
            });
        }
        
        function createVideoModal(playUrl, movieCode) {
            // 移除现有的模态框
            const existingModal = document.getElementById('videoModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 创建模态框HTML
            const modalHtml = `
                <div class="modal fade" id="videoModal" tabindex="-1" aria-labelledby="videoModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="videoModalLabel">播放: ${movieCode}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body p-0">
                                <div class="ratio ratio-16x9">
                                    <video controls autoplay class="w-100">
                                        <source src="${playUrl}" type="video/mp4">
                                        您的浏览器不支持视频播放。
                                    </video>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 添加到页面
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('videoModal'));
            modal.show();
            
            // 模态框关闭时清理
            document.getElementById('videoModal').addEventListener('hidden.bs.modal', function () {
                this.remove();
            });
            
            showToast('开始播放视频', 'success');
        }

        function playMovie115(movieCode) {
            // 显示加载提示
            showToast('正在获取播放地址...', 'info');
            
            // 调用之前实现的playVideo函数（在base.html中定义）
            if (typeof playVideo === 'function') {
                playVideo(movieCode);
            } else {
                // 如果playVideo函数不存在，直接实现播放逻辑
                fetch(`/api/video/play-url/${movieCode}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.play_url) {
                            // 创建视频播放器模态框
                            createVideoModal(data.play_url, movieCode);
                        } else {
                            // 如果没有找到播放地址，尝试搜索115文件
                            searchAndPlay115Files(movieCode);
                        }
                    })
                    .catch(error => {
                        console.error('获取播放地址失败:', error);
                        // 尝试搜索115文件
                        searchAndPlay115Files(movieCode);
                    });
            }
        }
        
        function searchAndPlay115Files(movieCode) {
            showToast('正在搜索115文件...', 'info');
            
            fetch(`/api/video/search-115`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    keyword: movieCode,
                    file_type: 'video'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.files && data.files.length > 0) {
                    // 找到文件，获取第一个视频文件的播放地址
                    const videoFile = data.files.find(file => 
                        file.name.toLowerCase().includes('.mp4') || 
                        file.name.toLowerCase().includes('.mkv') || 
                        file.name.toLowerCase().includes('.avi')
                    ) || data.files[0];
                    
                    if (videoFile) {
                        getFilePlayUrl(videoFile.file_id, movieCode);
                    } else {
                        showToast('未找到可播放的视频文件', 'error');
                    }
                } else {
                    showToast('未找到相关视频文件', 'error');
                }
            })
            .catch(error => {
                console.error('搜索115文件失败:', error);
                showToast('搜索文件失败: 网络错误', 'error');
            });
        }
        
        function getFilePlayUrl(fileId, movieCode) {
            showToast('正在获取播放地址...', 'info');
            
            fetch('/api/video/get-play-url', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    file_id: fileId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.play_url) {
                    createVideoModal(data.play_url, movieCode);
                } else {
                    showToast('获取播放地址失败: ' + (data.error || '未知错误'), 'error');
                }
            })
            .catch(error => {
                console.error('获取播放地址失败:', error);
                showToast('获取播放地址失败: 网络错误', 'error');
            });
        }
        
        function createVideoModal(playUrl, movieCode) {
            // 移除现有的模态框
            const existingModal = document.getElementById('videoModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 创建模态框HTML
            const modalHtml = `
                <div class="modal fade" id="videoModal" tabindex="-1" aria-labelledby="videoModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="videoModalLabel">播放视频 - ${movieCode}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body p-0">
                                <div class="ratio ratio-16x9">
                                    <video controls autoplay class="w-100">
                                        <source src="${playUrl}" type="video/mp4">
                                        您的浏览器不支持视频播放。
                                    </video>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 添加到页面
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('videoModal'));
            modal.show();
            
            // 模态框关闭时清理
            document.getElementById('videoModal').addEventListener('hidden.bs.modal', function () {
                this.remove();
            });
            
            showToast('开始播放视频', 'success');
        }
    </script>